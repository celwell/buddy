<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="generator" content="AsciiDoc 8.6.9">
<title>buddy documentation</title>
<link rel="stylesheet" href="static/niwi.css" type="text/css">
<link rel="stylesheet" href="static/pygments.css" type="text/css">


<script type="text/javascript" src="static/asciidoc.js"></script>
<script type="text/javascript" src="static/niwi.js"></script>
<script type="text/javascript">
/*<![CDATA[*/
asciidoc.install(2);
/*]]>*/
</script>
</head>
<body class="article" style="max-width:960px">
<div id="header">
<h1>buddy documentation</h1>
<span id="author">Andrey Antukh,</span><br>
<span id="email" class="monospaced">&lt;<a href="mailto:niwi@niwi.be">niwi@niwi.be</a>&gt;</span><br>
<span id="revnumber">version 0.1.2,</span>
<span id="revdate">2014-05-01</span>
<div id="toc">
  <div id="toctitle">Table of Contents</div>
  <noscript><p><b>JavaScript must be enabled in your browser to display the table of contents.</b></p></noscript>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="_introduction">1. Introduction</h2>
<div class="sectionbody">
<div class="paragraph"><p><em>buddy</em> is a complete security library for clojure with support for:</p></div>
<div class="ulist"><ul>
<li>
<p>
authentication, authorization &amp; access rules (ring/compojure extensions)
</p>
</li>
<li>
<p>
secure hash functions (digest)
</p>
</li>
<li>
<p>
password hashing algorithms
</p>
</li>
<li>
<p>
message/text signing (high level interface)
</p>
</li>
<li>
<p>
signature &amp; authentication (mac &amp; digital signature)
</p>
</li>
<li>
<p>
encryption (block &amp; stream ciphers)
</p>
</li>
<li>
<p>
key derivartion functions (kdf)
</p>
</li>
</ul></div>
<div class="paragraph"><p>Obviously backed by battle tested <a href="http://www.bouncycastle.org/specifications.html">bouncy castle</a> library.</p></div>
<div class="paragraph"><p><a href="api/index.html">API reference documentation.</a></p></div>
<div class="sect2">
<h3 id="_philosophy">1.1. Philosophy</h3>
<div class="paragraph"><p>Five most important rules:</p></div>
<div class="ulist"><ul>
<li>
<p>
Beautiful is better than ugly
</p>
</li>
<li>
<p>
Explicit is better than implicit
</p>
</li>
<li>
<p>
Simple is better than complex
</p>
</li>
<li>
<p>
Readability counts
</p>
</li>
</ul></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_project_maturity">2. Project Maturity</h2>
<div class="sectionbody">
<div class="paragraph"><p>Since <em>buddy</em> is a young project there can be some API breakage.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_install">3. Install</h2>
<div class="sectionbody">
<div class="paragraph"><p>This section covers installing <em>buddy</em>.</p></div>
<div class="sect2">
<h3 id="_requirements">3.1. Requirements</h3>
<div class="paragraph"><p><em>buddy</em> has support for these jvm versions:</p></div>
<div class="ulist"><ul>
<li>
<p>
JDK7
</p>
</li>
<li>
<p>
JDK8
</p>
</li>
</ul></div>
</div>
<div class="sect2">
<h3 id="_leiningen">3.2. Leiningen</h3>
<div class="paragraph"><p>The simplest way to use <em>buddy</em> in a Clojure project is by including
it as a dependency in your <strong><em>project.clj</em></strong>:</p></div>
<div class="listingblock">
<div class="title"><em>in project.clj</em></div>
<div class="content"><div class="highlight"><pre><span class="p">[</span><span class="nv">buddy</span> <span class="s">&quot;0.1.2&quot;</span><span class="p">]</span>
</pre></div></div></div>
</div>
<div class="sect2">
<h3 id="_maven">3.3. Maven</h3>
<div class="paragraph"><p>Also, you can use it with maven. First, add the clojars repository:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nt">&lt;repository&gt;</span>
    <span class="nt">&lt;id&gt;</span>clojars.org<span class="nt">&lt;/id&gt;</span>
    <span class="nt">&lt;url&gt;</span>http://clojars.org/repo<span class="nt">&lt;/url&gt;</span>
<span class="nt">&lt;/repository&gt;</span>
</pre></div></div></div>
<div class="paragraph"><p>Then for buddy:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>buddy<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>buddy<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;version&gt;</span>0.1.2<span class="nt">&lt;/version&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</pre></div></div></div>
</div>
<div class="sect2">
<h3 id="_get_the_code">3.4. Get the Code</h3>
<div class="paragraph"><p><em>buddy</em> is opensource and is entirelly developed on <a href="https://github.com/niwibe/buddy">github</a>.</p></div>
<div class="paragraph"><p>You can clone the public repository with this command:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre>git clone https://github.com/niwibe/buddy
</pre></div></div></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_core_library">4. Core library</h2>
<div class="sectionbody">
<div class="paragraph"><p>Buddy is splitted in "two libraries", the low level interface
and high level interface.</p></div>
<div class="paragraph"><p>Low level interface is located on <span class="monospaced">buddy.core</span> namespace and
has implementations for:</p></div>
<div class="ulist"><ul>
<li>
<p>
cryptographyc hash algorithms
</p>
</li>
<li>
<p>
key derivation algorithms
</p>
</li>
<li>
<p>
digital signature
</p>
</li>
<li>
<p>
message authentication (mac)
</p>
</li>
<li>
<p>
cryptography algorithms (block &amp; stream ciphers)
</p>
</li>
</ul></div>
<div class="sect2">
<h3 id="_cryptographic_hash_algorithms">4.1. Cryptographic hash algorithms</h3>
<div class="paragraph"><p>All hash algorithms are located on the <span class="monospaced">buddy.core.hash</span> namespace.</p></div>
<table class="tableblock frame-all grid-all"
style="
width:100%;
">
<caption class="title">Table 1. Available hash algorithms</caption>
<col style="width:50%;">
<col style="width:50%;">
<thead>
<tr>
<th class="tableblock halign-left valign-top" > Hash algorithm name  </th>
<th class="tableblock halign-left valign-top" > Digest size</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">SHA1</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">160</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">SHA2</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">256, 384, 512</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">SHA3</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">256, 384, 512</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">MD5</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">128</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Tiger</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">192</p></td>
</tr>
</tbody>
</table>
<div class="sect3">
<h4 id="_basic_usage">4.1.1. Basic usage</h4>
<div class="listingblock">
<div class="title">Import namespace example:</div>
<div class="content"><div class="highlight"><pre><span class="p">(</span><span class="nf">require</span> <span class="o">&#39;</span><span class="p">[</span><span class="nv">buddy.core.hash</span> <span class="ss">:as</span> <span class="nv">hash</span><span class="p">])</span>
<span class="p">(</span><span class="nf">require</span> <span class="o">&#39;</span><span class="p">[</span><span class="nv">buddy.core.codecs</span> <span class="ss">:refer</span> <span class="ss">:all</span><span class="p">])</span>
</pre></div></div></div>
<div class="listingblock">
<div class="title">Usage examples:</div>
<div class="content"><div class="highlight"><pre><span class="p">(</span><span class="nf">hash/sha256</span> <span class="s">&quot;foo bar&quot;</span><span class="p">)</span>
<span class="c1">;; -&gt; #&lt;byte[] [B@162a657e&gt;</span>

<span class="p">(</span><span class="nb">-&gt; </span><span class="p">(</span><span class="nf">hash/sha256</span> <span class="s">&quot;foo bar&quot;</span><span class="p">)</span>
    <span class="p">(</span><span class="nf">bytes-&gt;hex</span><span class="p">))</span>
<span class="c1">;; -&gt; &quot;fbc1a9f858ea9e177916964bd88c3d37b91a1e84412765e29950777f265c4b75&quot;</span>
</pre></div></div></div>
</div>
<div class="sect3">
<h4 id="_advanced_usage">4.1.2. Advanced usage</h4>
<div class="paragraph"><p>Hash functions are implemented using protocols and it can be extended
to other types. The default implementations also comes with implementation
for file like objects (<strong>File</strong>, <strong>URL</strong>, URI* and <strong>InputStream</strong>).</p></div>
<div class="listingblock">
<div class="title">Make hash of file example:</div>
<div class="content"><div class="highlight"><pre><span class="c1">;; Additional import for easy open files</span>
<span class="p">(</span><span class="nf">require</span> <span class="o">&#39;</span><span class="p">[</span><span class="nv">clojure.java.io</span> <span class="ss">:as</span> <span class="nv">io</span><span class="p">])</span>

<span class="p">(</span><span class="nb">-&gt; </span><span class="p">(</span><span class="nf">hash/sha256</span> <span class="p">(</span><span class="nf">io/input-stream</span> <span class="s">&quot;/tmp/some-file&quot;</span><span class="p">))</span>
    <span class="p">(</span><span class="nf">bytes-&gt;hex</span><span class="p">))</span>
<span class="c1">;; -&gt; &quot;bba878639499c8449f69efbfc699413eebfaf41d4b7a7faa560bfaf7e93a43dd&quot;</span>
</pre></div></div></div>
<div class="paragraph"><p>You can extend it for your own types using the
<strong>buddy.core.hash/Digest</strong> protocol:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="p">(</span><span class="kd">defprotocol </span><span class="nv">Digest</span>
  <span class="p">(</span><span class="nf">make-digest</span> <span class="p">[</span><span class="nv">data</span> <span class="nv">algorithm</span><span class="p">]))</span>
</pre></div></div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">Functions like <strong>sha256</strong> are aliases for the more generic
function <strong>digest</strong>.</td>
</tr></table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_message_authentication_code_algorithms">4.2. Message authentication code algorithms</h3>
<div class="paragraph"><p>Buddy comes with two mac implementations: <strong>HMac</strong> and <strong>Poly1305</strong>.</p></div>
<div class="sect3">
<h4 id="_hmac">4.2.1. HMac</h4>
<div class="paragraph"><p>There are two variants of hmac: simple and salted. Both are available
in <span class="monospaced">buddy.core.mac.hmac</span> namespace.</p></div>
<div class="sect4">
<h5 id="_basic_usage_2">Basic usage</h5>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="c1">;; Import required namespaces</span>
<span class="p">(</span><span class="nf">require</span> <span class="o">&#39;</span><span class="p">[</span><span class="nv">buddy.core.mac.hmac</span> <span class="ss">:as</span> <span class="nv">hmac</span><span class="p">])</span>
<span class="p">(</span><span class="nf">require</span> <span class="o">&#39;</span><span class="p">[</span><span class="nv">buddy.core.codecs</span> <span class="ss">:refer</span> <span class="ss">:all</span><span class="p">])</span>

<span class="c1">;; Generate sha256 hmac over string</span>
<span class="p">(</span><span class="nb">-&gt; </span><span class="p">(</span><span class="nf">hmac/hmac-sha256</span> <span class="s">&quot;foo bar&quot;</span> <span class="s">&quot;mysecretkey&quot;</span><span class="p">)</span>
    <span class="p">(</span><span class="nf">bytes-&gt;hex</span><span class="p">))</span>
<span class="c1">;; -&gt; &quot;61849448bdbb67b39d609471eead667e65b0d1b9e01b1c3bf7aa56b83e9c8083&quot;</span>

<span class="c1">;; Same example but using salted variant</span>
<span class="p">(</span><span class="nb">-&gt; </span><span class="p">(</span><span class="nf">hmac/salted-hmac-sha256</span> <span class="s">&quot;foo bar&quot;</span> <span class="s">&quot;salt&quot;</span> <span class="s">&quot;mysecretkey&quot;</span><span class="p">)</span>
    <span class="p">(</span><span class="nf">bytes-&gt;hex</span><span class="p">))</span>
<span class="c1">;; -&gt; &quot;bd5f7a0040430a73f4845bac8f980c6398b4baae8a22efcc22038be0f4dd9678&quot;</span>
</pre></div></div></div>
<div class="paragraph"><p>The key parameter can be any type that implements the <strong>ByteArray</strong> protocol
defined on <span class="monospaced">buddy.core.codecs</span> namespace. It comes with default implementation for
<span class="monospaced">byte[]</span> and <span class="monospaced">java.lang.String</span>.</p></div>
</div>
<div class="sect4">
<h5 id="_advanced_usage_2">Advanced usage</h5>
<div class="paragraph"><p>Like hash functions, hmac is implemented using Clojure
protocols and it comes with default implementated for: String, byte[],
<strong>File</strong>, <strong>URL</strong>, <strong>URI</strong> and <strong>InputStream</strong>.</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="p">(</span><span class="nf">require</span> <span class="o">&#39;</span><span class="p">[</span><span class="nv">clojure.java.io</span> <span class="ss">:as</span> <span class="nv">io</span><span class="p">])</span>

<span class="c1">;; Generate hmac for file</span>
<span class="p">(</span><span class="nb">-&gt; </span><span class="p">(</span><span class="nf">io/input-stream</span> <span class="s">&quot;/tmp/somefile&quot;</span><span class="p">)</span>
    <span class="p">(</span><span class="nf">hmac/hmac-sha256</span> <span class="s">&quot;mysecretkey&quot;</span><span class="p">)</span>
    <span class="p">(</span><span class="nf">bytes-&gt;hex</span><span class="p">))</span>
<span class="c1">;; -&gt; &quot;4cb793e600848da2053238003fce4c010233c49df3e6a04119b4287eb464c27e&quot;</span>
</pre></div></div></div>
<div class="paragraph"><p>You can extend it for your own types using <span class="monospaced">buddy.core.hmac/HMac</span> protocol:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="p">(</span><span class="kd">defprotocol </span><span class="nv">HMac</span>
  <span class="p">(</span><span class="nf">make-hmac</span> <span class="p">[</span><span class="nv">data</span> <span class="nb">key </span><span class="nv">algorithm</span><span class="p">]))</span>
</pre></div></div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">Functions like <strong>hmac-sha256</strong> just alias the more generic functions
<strong>hmac</strong> and <strong>shmac</strong>.</td>
</tr></table>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_poly1305">4.2.2. Poly1305</h4>
<div class="paragraph"><p>Poly1305 is a cryptographic message authentication code
(MAC) written by Daniel J. Bernstein. It can be used to verify the
data integrity and the authenticity of a message.</p></div>
<div class="paragraph"><p>The security of Poly1305 is very close to the bock cipher algorithm.
As a result, the only way for an attacker to break Poly1305 is to break
the cipher.</p></div>
<div class="paragraph"><p>Poly1305 offers cipher replaceability. If anything does
go wrong with one, it can be substituted with an other with identical
security guarantee.</p></div>
<div class="paragraph"><p>Unlike <strong>HMac</strong>, it requires initialization vector (IV). Is like a
salt, but required for security guarantee, and it should be generated
using strong random number generator. Also, iv should be of same
length as choised cipher block size.</p></div>
<div class="sect4">
<h5 id="_basic_usage_3">Basic usage</h5>
<div class="paragraph"><p>The default specification talks about AES as default block cipher,
but buddy comes with support for three block ciphers: AES, Serpent
and Twofish.</p></div>
<div class="listingblock">
<div class="title">Make mac using Serpent block cipher with random IV</div>
<div class="content"><div class="highlight"><pre><span class="p">(</span><span class="nf">require</span> <span class="o">&#39;</span><span class="p">[</span><span class="nv">buddy.core.codecs</span> <span class="ss">:refe</span> <span class="p">[</span><span class="nv">bytes-&gt;hex</span><span class="p">]])</span>
<span class="p">(</span><span class="nf">require</span> <span class="o">&#39;</span><span class="p">[</span><span class="nv">buddy.core.mac.poly1305</span> <span class="ss">:as</span> <span class="nv">poly</span><span class="p">])</span>
<span class="p">(</span><span class="nf">require</span> <span class="o">&#39;</span><span class="p">[</span><span class="nv">buddy.core.keys</span> <span class="ss">:refer</span> <span class="p">[</span><span class="nv">make-random-bytes</span><span class="p">]])</span>

<span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">iv</span>  <span class="p">(</span><span class="nf">make-random-bytes</span> <span class="mi">16</span><span class="p">)</span>
      <span class="nv">mac</span> <span class="p">(</span><span class="nf">poly/poly1305</span> <span class="s">&quot;some-data&quot;</span> <span class="s">&quot;mysecret&quot;</span> <span class="nv">iv</span> <span class="ss">:serpent</span><span class="p">)]</span>
  <span class="p">(</span><span class="nb">println </span><span class="p">(</span><span class="nf">bytes-&gt;hex</span> <span class="nv">mac</span><span class="p">)))</span>
<span class="c1">;; =&gt; &quot;1976b1c490c306e7304a59dfacee4207&quot;</span>
</pre></div></div></div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_public_private_keypairs">4.3. Public/Private keypairs</h3>
<div class="paragraph"><p>Before explaining digital signatures, you need read public/private keypairs
and conver them to usable objects. Buddy has limited support for read:</p></div>
<div class="ulist"><ul>
<li>
<p>
RSA keypair
</p>
</li>
<li>
<p>
ECDSA keypair
</p>
</li>
</ul></div>
<div class="sect3">
<h4 id="_rsa_keypair">4.3.1. RSA Keypair</h4>
<div class="paragraph"><p>RSA keypair is used for obvious rsa encrypt/decrypt operations, but also
is used for make digital signature with any rsa derived algorithm.</p></div>
<div class="listingblock">
<div class="title">Read keys</div>
<div class="content"><div class="highlight"><pre><span class="p">(</span><span class="nf">require</span> <span class="o">&#39;</span><span class="p">[</span><span class="nv">buddy.core.keys</span> <span class="ss">:as</span> <span class="nv">keys</span><span class="p">])</span>

<span class="c1">;; The last parameter is optional and is only mandatory</span>
<span class="c1">;; if a private key is encrypted.</span>
<span class="p">(</span><span class="k">def </span><span class="nv">privkey</span> <span class="p">(</span><span class="nf">keys/private-key</span> <span class="s">&quot;test/_files/privkey.3des.rsa.pem&quot;</span> <span class="s">&quot;secret&quot;</span><span class="p">)</span>
<span class="p">(</span><span class="k">def </span><span class="nv">pubkey</span> <span class="p">(</span><span class="nf">keys/public-key</span> <span class="s">&quot;test/_files/pubkey.3des.rsa.pem&quot;</span><span class="p">))</span>
</pre></div></div></div>
<div class="listingblock">
<div class="title">Generate a RSA Keypair using openssl.</div>
<div class="content"><div class="highlight"><pre><span class="c"># Generate aes256 encrypted private key</span>
openssl genrsa -aes256 -out privkey.pem 2048

<span class="c"># Generate public key from previously created private key.</span>
openssl rsa -pubout -in privkey.pem -out pubkey.pem
</pre></div></div></div>
</div>
<div class="sect3">
<h4 id="_ecdsa_keypair">4.3.2. ECDSA Keypair</h4>
<div class="paragraph"><p>Like RSA keypair, ECDSA also are used for make a digital signature and
can be readed like previous rsa examples.</p></div>
<div class="listingblock">
<div class="title">Read keys.</div>
<div class="content"><div class="highlight"><pre><span class="p">(</span><span class="nf">require</span> <span class="o">&#39;</span><span class="p">[</span><span class="nv">buddy.core.keys</span> <span class="ss">:as</span> <span class="nv">keys</span><span class="p">])</span>

<span class="c1">;; The last parameter is optional and is only mandatory</span>
<span class="c1">;; if a private key is encrypted.</span>
<span class="p">(</span><span class="k">def </span><span class="nv">privkey</span> <span class="p">(</span><span class="nf">keys/private-key</span> <span class="s">&quot;test/_files/privkey.ecdsa.pem&quot;</span> <span class="s">&quot;secret&quot;</span><span class="p">)</span>
<span class="p">(</span><span class="k">def </span><span class="nv">pubkey</span> <span class="p">(</span><span class="nf">keys/public-key</span> <span class="s">&quot;test/_files/pubkey.ecdsa.pem&quot;</span><span class="p">))</span>
</pre></div></div></div>
<div class="listingblock">
<div class="title">Generate a ECDSA Keypair using openssl.</div>
<div class="content"><div class="highlight"><pre><span class="c"># Generating params file</span>
openssl ecparam -name prime256v1 -out ecparams.pem

<span class="c"># Generate a private key from params file</span>
openssl ecparam -in ecparams.pem -genkey -noout -out ecprivkey.pem

<span class="c"># Generate a public key from private key</span>
openssl ec -in ecprivkey.pem -pubout -out ecpubkey.pem
</pre></div></div></div>
</div>
</div>
<div class="sect2">
<h3 id="_digital_signatures">4.4. Digital Signatures</h3>
<div class="paragraph"><p>Digital Signatures differs from Mac as Mac values are both generated and verified
using the same secret key. Digital Signatures requires public/private keypair, it
signs using private key and verifies signature using a public key.</p></div>
<div class="sect3">
<h4 id="_rsassa_pss">4.4.1. RSASSA PSS</h4>
<div class="paragraph"><p>RSASSA-PSS is an improved probabilistic signature scheme with
appendix. What that means is that you can use a private RSA key
to sign data in combination with some random input.</p></div>
<div class="paragraph"><p><a href="http://www.ietf.org/rfc/rfc3447.txt">rfc3447.txt</a></p></div>
<div class="listingblock">
<div class="title">Sign sample string using rsassa-pss.</div>
<div class="content"><div class="highlight"><pre><span class="p">(</span><span class="nf">require</span> <span class="o">&#39;</span><span class="p">[</span><span class="nv">buddy.core.keys</span> <span class="ss">:as</span> <span class="nv">keys</span><span class="p">])</span>
<span class="p">(</span><span class="nf">require</span> <span class="o">&#39;</span><span class="p">[</span><span class="nv">buddy.core.sign</span> <span class="ss">:as</span> <span class="nv">sign</span><span class="p">])</span>

<span class="c1">;; Read private key</span>
<span class="p">(</span><span class="k">def </span><span class="nv">rsaprivkey</span> <span class="p">(</span><span class="nf">keys/private-key</span> <span class="s">&quot;test/_files/privkey.3des.rsa.pem&quot;</span> <span class="s">&quot;secret&quot;</span><span class="p">))</span>

<span class="c1">;; Make signature</span>
<span class="p">(</span><span class="k">def </span><span class="nv">signature</span> <span class="p">(</span><span class="nf">sign/rsassa-pss-sha256</span> <span class="s">&quot;foo&quot;</span> <span class="nv">rsaprivkey</span><span class="p">))</span>

<span class="c1">;; Now signature contains a byte[] with signature of &quot;foo&quot; string</span>
</pre></div></div></div>
<div class="listingblock">
<div class="title">Verify signature using rsassa-pss.</div>
<div class="content"><div class="highlight"><pre><span class="c1">;; Read private key</span>
<span class="p">(</span><span class="k">def </span><span class="nv">rsapubkey</span> <span class="p">(</span><span class="nf">keys/private-key</span> <span class="s">&quot;test/_files/pubkey.3des.rsa.pem&quot;</span><span class="p">))</span>

<span class="c1">;; Make verification</span>
<span class="p">(</span><span class="nf">sign/rsassa-pss-sha256-verify</span> <span class="s">&quot;foo&quot;</span> <span class="nv">signature</span> <span class="nv">rsapubkey</span><span class="p">))</span>
<span class="c1">;; =&gt; true</span>
</pre></div></div></div>
</div>
<div class="sect3">
<h4 id="_rsassa_pkcs1_v1_5">4.4.2. RSASSA PKCS1 v1.5</h4>
<div class="paragraph"><p>RSASSA-PSS is an probabilistic signature scheme with appendix.
What that means is that you can use a private RSA key to sign data.</p></div>
<div class="paragraph"><p><a href="http://www.ietf.org/rfc/rfc3447.txt">rfc3447.txt</a></p></div>
<div class="listingblock">
<div class="title">Sign sample string using rsassa-pkcs.</div>
<div class="content"><div class="highlight"><pre><span class="p">(</span><span class="nf">require</span> <span class="o">&#39;</span><span class="p">[</span><span class="nv">buddy.core.keys</span> <span class="ss">:as</span> <span class="nv">keys</span><span class="p">])</span>
<span class="p">(</span><span class="nf">require</span> <span class="o">&#39;</span><span class="p">[</span><span class="nv">buddy.core.sign</span> <span class="ss">:as</span> <span class="nv">sign</span><span class="p">])</span>

<span class="c1">;; Read private key</span>
<span class="p">(</span><span class="k">def </span><span class="nv">rsaprivkey</span> <span class="p">(</span><span class="nf">keys/private-key</span> <span class="s">&quot;test/_files/privkey.3des.rsa.pem&quot;</span> <span class="s">&quot;secret&quot;</span><span class="p">))</span>

<span class="c1">;; Make signature</span>
<span class="p">(</span><span class="k">def </span><span class="nv">signature</span> <span class="p">(</span><span class="nf">sign/rsassa-pkcs-sha256</span> <span class="s">&quot;foo&quot;</span> <span class="nv">rsaprivkey</span><span class="p">))</span>

<span class="c1">;; Now signature contains a byte[] with signature of &quot;foo&quot; string</span>
</pre></div></div></div>
<div class="listingblock">
<div class="title">Verify signature using rsassa-pkcs.</div>
<div class="content"><div class="highlight"><pre><span class="c1">;; Read private key</span>
<span class="p">(</span><span class="k">def </span><span class="nv">rsapubkey</span> <span class="p">(</span><span class="nf">keys/private-key</span> <span class="s">&quot;test/_files/pubkey.3des.rsa.pem&quot;</span><span class="p">))</span>

<span class="c1">;; Make verification</span>
<span class="p">(</span><span class="nf">sign/rsassa-pkcs-sha256-verify</span> <span class="s">&quot;foo&quot;</span> <span class="nv">signature</span> <span class="nv">rsapubkey</span><span class="p">))</span>
<span class="c1">;; =&gt; true</span>
</pre></div></div></div>
</div>
<div class="sect3">
<h4 id="_eliptic_curve_dsa">4.4.3. Eliptic Curve DSA</h4>
<div class="paragraph"><p>Elliptic Curve Digital Signature Algorithm (ECDSA) is a variant of the
Digital Signature Algorithm (DSA) which uses elliptic curve cryptography.</p></div>
<div class="listingblock">
<div class="title">Sign sample string using ecdsa.</div>
<div class="content"><div class="highlight"><pre><span class="p">(</span><span class="nf">require</span> <span class="o">&#39;</span><span class="p">[</span><span class="nv">buddy.core.keys</span> <span class="ss">:as</span> <span class="nv">keys</span><span class="p">])</span>
<span class="p">(</span><span class="nf">require</span> <span class="o">&#39;</span><span class="p">[</span><span class="nv">buddy.core.sign</span> <span class="ss">:as</span> <span class="nv">sign</span><span class="p">])</span>

<span class="c1">;; Read private key</span>
<span class="p">(</span><span class="k">def </span><span class="nv">ecdsaprivkey</span> <span class="p">(</span><span class="nf">keys/private-key</span> <span class="s">&quot;test/_files/privkey.ecdsa.pem&quot;</span> <span class="s">&quot;secret&quot;</span><span class="p">))</span>

<span class="c1">;; Make signature</span>
<span class="p">(</span><span class="k">def </span><span class="nv">signature</span> <span class="p">(</span><span class="nf">sign/ecdsa-sha256</span> <span class="s">&quot;foo&quot;</span> <span class="nv">ecdsaprivkey</span><span class="p">))</span>
</pre></div></div></div>
<div class="listingblock">
<div class="title">Verify signature using ecdsa.</div>
<div class="content"><div class="highlight"><pre><span class="c1">;; Read private key</span>
<span class="p">(</span><span class="k">def </span><span class="nv">ecdsapubkey</span> <span class="p">(</span><span class="nf">keys/private-key</span> <span class="s">&quot;test/_files/pubkey.ecdsa.pem&quot;</span><span class="p">))</span>

<span class="c1">;; Make verification</span>
<span class="p">(</span><span class="nf">sign/ecdsa-sha256-verify</span> <span class="s">&quot;foo&quot;</span> <span class="nv">signature</span> <span class="nv">ecdsapubkey</span><span class="p">))</span>
<span class="c1">;; =&gt; true</span>
</pre></div></div></div>
</div>
</div>
<div class="sect2">
<h3 id="_key_derivation_functions">4.5. Key Derivation Functions</h3>
<div class="paragraph"><p>Key derivation functions are often used in conjunction with non-secret parameters
to derive one or more keys from a common secret value.</p></div>
<div class="paragraph"><p><strong>buddy</strong> commes with several of them:</p></div>
<table class="tableblock frame-all grid-all"
style="
width:100%;
">
<caption class="title">Table 2. Supported key derivation functions.</caption>
<col style="width:50%;">
<col style="width:50%;">
<thead>
<tr>
<th class="tableblock halign-left valign-top" >Algorithm name </th>
<th class="tableblock halign-left valign-top" > Constructor</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">HKDF</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><span class="monospaced">buddy.core.kdf/hkdf</span></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">KDF1</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><span class="monospaced">buddy.core.kdf/kdf1</span></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">KDF2</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><span class="monospaced">buddy.core.kdf/kdf2</span></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">CMKDF</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><span class="monospaced">buddy.core.kdf/cmkdf</span></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">FMKDF</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><span class="monospaced">buddy.core.kdf/fmkdf</span></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">DPIMKDF</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><span class="monospaced">buddy.core.kdf/dpimkdf</span></p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">All key derivation functions work with byte arrays. For following examples, <span class="monospaced">buddy.core.codecs</span>
functions for convert strings to byte arrays.</td>
</tr></table>
</div>
<div class="sect3">
<h4 id="_hkdf">4.5.1. HKDF</h4>
<div class="paragraph"><p>HMAC-based Extract-and-Expand Key Derivation Function (HKDF) implemented according to IETF RFC 5869</p></div>
<div class="listingblock">
<div class="title">Example using hkdf</div>
<div class="content"><div class="highlight"><pre><span class="p">(</span><span class="nf">require</span> <span class="o">&#39;</span><span class="p">[</span><span class="nv">buddy.core.codecs</span> <span class="ss">:refer</span> <span class="ss">:all</span><span class="p">])</span>
<span class="p">(</span><span class="nf">require</span> <span class="o">&#39;</span><span class="p">[</span><span class="nv">buddy.core.kdf</span> <span class="ss">:as</span> <span class="nv">kdf</span><span class="p">])</span>

<span class="c1">;; Using hkdf derivation functions. It requires a</span>
<span class="c1">;; key data, salt and optionally info field that can</span>
<span class="c1">;; contain any random data.</span>

<span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">kfn</span> <span class="p">(</span><span class="nf">kdf/hkdf</span> <span class="p">(</span><span class="nf">str-&gt;bytes</span> <span class="s">&quot;mysecretkey&quot;</span><span class="p">)</span>
                    <span class="p">(</span><span class="nf">str-&gt;bytes</span> <span class="s">&quot;mypublicsalt&quot;</span><span class="p">)</span>
                    <span class="nv">nil</span> <span class="c1">;; info parameter can be nil</span>
                    <span class="ss">:sha256</span><span class="p">)]</span>
  <span class="p">(</span><span class="nb">-&gt; </span><span class="p">(</span><span class="nf">kdf/generate-bytes!</span> <span class="nv">kfn</span> <span class="mi">8</span><span class="p">)</span>
      <span class="p">(</span><span class="nf">bytes-&gt;hex</span><span class="p">)))</span>
<span class="c1">;; =&gt; &quot;0faba553152fce4f&quot;</span>
</pre></div></div></div>
</div>
<div class="sect3">
<h4 id="_kdf1_2">4.5.2. KDF1/2</h4>
<div class="paragraph"><p>KDF1/2 hash based key derivation functions for derived keys and ivs as defined by IEEE P1363a/ISO 18033.</p></div>
<div class="listingblock">
<div class="title">Example using kdf1 or kdf2</div>
<div class="content"><div class="highlight"><pre><span class="p">(</span><span class="nf">require</span> <span class="o">&#39;</span><span class="p">[</span><span class="nv">buddy.core.codecs</span> <span class="ss">:refer</span> <span class="ss">:all</span><span class="p">])</span>
<span class="p">(</span><span class="nf">require</span> <span class="o">&#39;</span><span class="p">[</span><span class="nv">buddy.core.kdf</span> <span class="ss">:as</span> <span class="nv">kdf</span><span class="p">])</span>

<span class="c1">;; kdf1 and kdf2 are very similar and has the same</span>
<span class="c1">;; consturctor signature. Requires: key data, salt</span>
<span class="c1">;; and hash algorithm keyword.</span>

<span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">kfn</span> <span class="p">(</span><span class="nf">kdf/kdf2</span> <span class="p">(</span><span class="nf">str-&gt;bytes</span> <span class="s">&quot;mysecretkey&quot;</span><span class="p">)</span> <span class="p">(</span><span class="nf">str-&gt;bytes</span> <span class="s">&quot;mypublicsalt&quot;</span><span class="p">)</span> <span class="ss">:sha256</span><span class="p">)]</span>
  <span class="p">(</span><span class="nb">-&gt; </span><span class="p">(</span><span class="nf">kdf/generate-bytes!</span> <span class="nv">kfn</span> <span class="mi">8</span><span class="p">)</span>
      <span class="p">(</span><span class="nf">bytes-&gt;hex</span><span class="p">)))</span>
<span class="c1">;; =&gt; &quot;0faba553152fce4f&quot;</span>
</pre></div></div></div>
</div>
<div class="sect3">
<h4 id="_counter_mode_kdf">4.5.3. Counter Mode KDF</h4>
<div class="paragraph"><p>Hash based KDF with counter mode defined by the publicly available NIST SP 800-108 specification.</p></div>
</div>
<div class="sect3">
<h4 id="_feedback_mode_kdf">4.5.4. Feedback Mode KDF</h4>
<div class="paragraph"><p>Hash based KDF with feedback mode defined by the publicly available NIST SP 800-108 specification.</p></div>
</div>
<div class="sect3">
<h4 id="_double_pipeline_iteration_mode_kdf">4.5.5. Double-Pipeline Iteration Mode KDF</h4>
<div class="paragraph"><p>Hash based KDF with Double-Pipeline Iteration Mode defined by the publicly available
NIST SP 800-108 specification.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_ciphers">4.6. Ciphers</h3>
<div class="paragraph"><p>TODO</p></div>
</div>
<div class="sect2">
<h3 id="_codecs_binary_8594_string_conversion">4.7. Codecs (binary &#8594; string conversion)</h3>
<div class="paragraph"><p>Implements some useful and widely used around all buddy library functions
for make conversions between strings, bytes, hex encoded strings and base64
encoded strings.</p></div>
<div class="paragraph"><p>No documentation found for this part, but you can view source code for it.</p></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_high_level_library">5. High Level Library</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_message_signing">5.1. Message Signing</h3>
<div class="paragraph"><p>The "signing framework" of <em>buddy</em> is mainly based on django&#8217;s
<a href="https://docs.djangoproject.com/en/1.6/topics/signing/">Cryptographic
signing</a> library but extended with various signing algorithms and cryptography
support.</p></div>
<div class="paragraph"><p>It can be used for several purposes:</p></div>
<div class="ulist"><ul>
<li>
<p>
Safety send/store signed or encrypted messages.
</p>
</li>
<li>
<p>
Safely storing session data in cookies instead of a database (It prevents others from changing session content)
</p>
</li>
<li>
<p>
Self contained token generation for use it on completely stateless token based authentication.
</p>
</li>
</ul></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">this library is used by one of authentication backends for implement token based stateless authentication.</td>
</tr></table>
</div>
<table class="tableblock frame-all grid-all"
style="
width:100%;
">
<caption class="title">Table 3. Supported Algorithms</caption>
<col style="width:25%;">
<col style="width:25%;">
<col style="width:25%;">
<col style="width:25%;">
<thead>
<tr>
<th class="tableblock halign-left valign-top" >Algorithm name     </th>
<th class="tableblock halign-left valign-top" > Hash algorithms   </th>
<th class="tableblock halign-left valign-top" > Keywords           </th>
<th class="tableblock halign-left valign-top" > Priv/Pub Key?</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Elliptic Curve DSA</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">sha256, sha512</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><span class="monospaced">:es256</span>, <span class="monospaced">:es512</span></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Yes</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">RSASSA PSS</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">sha256, sha512</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><span class="monospaced">:ps256</span>, <span class="monospaced">:ps512</span></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Yes</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">RSASSA PKCS1 v1_5</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">sha256, sha512</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><span class="monospaced">:rs256</span>, <span class="monospaced">:rs256</span></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Yes</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">HMAC</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">sha256*, sha512</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><span class="monospaced">:hs256</span>, <span class="monospaced">:hs256</span></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">No</p></td>
</tr>
</tbody>
</table>
<div class="paragraph"><p>* indicates the default value.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph"><p>Only HMAC based algorithm supports plain text secret keys, If you want use
Digital Signature instead of hmac, you must have a key pair (public and private).</p></div>
</td>
</tr></table>
</div>
<div class="sect3">
<h4 id="_using_low_level_api">5.1.1. Using low level api</h4>
<div class="paragraph"><p>There are four signing functions in <strong><span class="monospaced">buddy.sign.generic</span></strong> namespace: <span class="monospaced">sign</span>,
<span class="monospaced">unsign</span>, <span class="monospaced">loads</span> and <span class="monospaced">dumps</span>.</p></div>
<div class="paragraph"><p><span class="monospaced">sign</span> and <span class="monospaced">unsign</span> are low level and work primarily with strings.</p></div>
<div class="listingblock">
<div class="title">Unsigning previously signed data</div>
<div class="content"><div class="highlight"><pre><span class="p">(</span><span class="nf">require</span> <span class="o">&#39;</span><span class="p">[</span><span class="nv">buddy.sign.generic</span> <span class="ss">:refer</span> <span class="p">[</span><span class="nv">sign</span> <span class="nv">unsign</span><span class="p">]])</span>

<span class="c1">;; Sign data</span>
<span class="p">(</span><span class="k">def </span><span class="nv">signed-data</span> <span class="p">(</span><span class="nf">sign</span> <span class="s">&quot;mystring&quot;</span> <span class="s">&quot;my-secret-key&quot;</span><span class="p">))</span>

<span class="c1">;; signed-data should contain a string similar to:</span>
<span class="c1">;; &quot;mystring:f08dd937a438f43639d34a345910148cb933ea8ea0c2c306e8733e0255677e3d:MTM...&quot;</span>

<span class="c1">;; Unsign previosly signed data</span>
<span class="p">(</span><span class="k">def </span><span class="nv">unsigned-data</span> <span class="p">(</span><span class="nf">unsign</span> <span class="nv">signed-data</span> <span class="s">&quot;my-secret-key&quot;</span><span class="p">))</span>

<span class="c1">;; unsigned-data should contain the original string: &quot;mystring&quot;</span>
</pre></div></div></div>
<div class="paragraph"><p>The signing process consists of append signatures to the original
string, separating the signature with a predefined separator (default
":" char).</p></div>
<div class="paragraph"><p>Each signature have attached a timestamp (with millisecond of accuracy) and you can
invalidate signed messages based on their age.</p></div>
<div class="listingblock">
<div class="title">Invalidate signed data using timestamp</div>
<div class="content"><div class="highlight"><pre><span class="c1">;; Unsign with maxago (15min)</span>
<span class="p">(</span><span class="k">def </span><span class="nv">unsigned-data</span> <span class="p">(</span><span class="nf">unsign</span> <span class="nv">signed-data</span> <span class="s">&quot;my-secret-key&quot;</span> <span class="p">{</span><span class="ss">:maxago</span> <span class="p">(</span><span class="nb">* </span><span class="mi">60</span> <span class="mi">15</span> <span class="mi">1000</span><span class="p">)}))</span>

<span class="c1">;; unsigned-data should contain a nil value if the signing date is</span>
<span class="c1">;; older than 15 min.</span>
</pre></div></div></div>
</div>
<div class="sect3">
<h4 id="_protecting_complex_data_structures">5.1.2. Protecting complex data structures</h4>
<div class="paragraph"><p>If you wish to protect a native data structure (hash-map, hash-set,
list, vector, etc&#8230;)  you can do so using the signing <span class="monospaced">dumps</span> and
<span class="monospaced">loads</span> functions.</p></div>
<div class="paragraph"><p>They accept the same parameters as their low level friends, but can also sign
more complex data.</p></div>
<div class="listingblock">
<div class="title">Sign/Unsign Clojure hash-map</div>
<div class="content"><div class="highlight"><pre><span class="p">(</span><span class="nf">require</span> <span class="o">&#39;</span><span class="p">[</span><span class="nv">buddy.sign.generic</span> <span class="ss">:refer</span> <span class="p">[</span><span class="nv">dumps</span> <span class="nv">loads</span><span class="p">]])</span>

<span class="c1">;; Sign data</span>
<span class="p">(</span><span class="k">def </span><span class="nv">signed-data</span> <span class="p">(</span><span class="nf">dumps</span> <span class="p">{</span><span class="ss">:userid</span> <span class="mi">1</span><span class="p">}</span> <span class="s">&quot;my-secret-key&quot;</span><span class="p">))</span>

<span class="c1">;; signed-data should contain a string similar to:</span>
<span class="c1">;; &quot;TlBZARlgGwAAAAIOAAAABnVzZXJpZCsAAAAAAAAAAQ:59d9e8063ad80f6abd3092b45857810b10f5...&quot;</span>

<span class="c1">;; Unsign previously signed data</span>
<span class="p">(</span><span class="k">def </span><span class="nv">unsigned-data</span> <span class="p">(</span><span class="nf">loads</span> <span class="nv">signed-data</span> <span class="s">&quot;my-secret-key&quot;</span><span class="p">))</span>

<span class="c1">;; unsigned-data should contain a original map: {:userid 1}</span>
</pre></div></div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">it uses a Clojure serialization library <a href="https://github.com/ptaoussanis/nippy">Nippy</a></td>
</tr></table>
</div>
</div>
<div class="sect3">
<h4 id="_using_digital_signature_algorithms">5.1.3. Using Digital Signature algorithms</h4>
<div class="paragraph"><p>For use anyone of digital signature algorithms you must have a private/public key. If you
don&#8217;t have one, don&#8217;t worry, generate one it&#8217;s very easy (using <strong>openssl</strong>).</p></div>
<div class="sect4">
<h5 id="_elliptic_curve_dsa">Elliptic Curve DSA</h5>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="c"># Generating params file</span>
openssl ecparam -name prime256v1 -out ecparams.pem

<span class="c"># Generate a private key from params file</span>
openssl ecparam -in ecparams.pem -genkey -noout -out ecprivkey.pem

<span class="c"># Generate a public key from private key</span>
openssl ec -in ecprivkey.pem -pubout -out ecpubkey.pem
</pre></div></div></div>
</div>
<div class="sect4">
<h5 id="_rsa_based_signatures">RSA based signatures</h5>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="c"># Generate aes256 encrypted private key</span>
openssl genrsa -aes256 -out privkey.pem 2048

<span class="c"># Generate public key from previously created private key.</span>
openssl rsa -pubout -in privkey.pem -out pubkey.pem
</pre></div></div></div>
</div>
<div class="sect4">
<h5 id="_using_digital_signature_keys_for_signing">Using Digital Signature Keys for signing</h5>
<div class="paragraph"><p>Now, having generated key pair, you can sign your messages with Digital
Signature algorithms also previously mentioned.</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="p">(</span><span class="nf">require</span> <span class="o">&#39;</span><span class="p">[</span><span class="nv">buddy.sign.generic</span> <span class="ss">:refer</span> <span class="p">[</span><span class="nv">sign</span> <span class="nv">unsign</span><span class="p">]])</span>

<span class="c1">;; Import namespace for managing/reading keys</span>
<span class="p">(</span><span class="nf">require</span> <span class="o">&#39;</span><span class="p">[</span><span class="nv">buddy.core.keys</span> <span class="ss">:as</span> <span class="nv">keys</span><span class="p">])</span>

<span class="c1">;; Create keys instances</span>
<span class="p">(</span><span class="k">def </span><span class="nv">ec-privkey</span> <span class="p">(</span><span class="nf">keys/private-key</span> <span class="s">&quot;ecprivkey.pem&quot;</span><span class="p">))</span>
<span class="p">(</span><span class="k">def </span><span class="nv">ec-pubkey</span> <span class="p">(</span><span class="nf">keys/public-key</span> <span class="s">&quot;ecpubkey.pem&quot;</span><span class="p">))</span>

<span class="c1">;; Use them like plain secret password with hmac algorithms for sign</span>
<span class="p">(</span><span class="k">def </span><span class="nv">signed-data</span> <span class="p">(</span><span class="nf">sign</span> <span class="s">&quot;mystring&quot;</span> <span class="nv">ec-privkey</span> <span class="p">{</span><span class="ss">:alg</span> <span class="ss">:ec256</span><span class="p">}))</span>

<span class="c1">;; And unsign</span>
<span class="p">(</span><span class="k">def </span><span class="nv">unsigned-data</span> <span class="p">(</span><span class="nf">unsign</span> <span class="nv">signed-data</span> <span class="nv">ec-pubkey</span> <span class="p">{</span><span class="ss">:alg</span> <span class="ss">:ec256</span><span class="p">}))</span>
</pre></div></div></div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_password_hashers">5.2. Password Hashers</h3>
<div class="paragraph"><p>Another important part of a good authentication/authorization library
is providing some facilities for generating secure passwords.</p></div>
<div class="paragraph"><p><em>buddy</em> comes with a few functions for generating and verifying passwords
with the widely used password derivation algorithms: bcrypt and pbkdf2.</p></div>
<table class="tableblock frame-all grid-all"
style="
width:100%;
">
<caption class="title">Table 4. Supported password hashers algorithms</caption>
<col style="width:33%;">
<col style="width:33%;">
<col style="width:33%;">
<thead>
<tr>
<th class="tableblock halign-left valign-top" > Hash algorithm name  </th>
<th class="tableblock halign-left valign-top" > Namespace              </th>
<th class="tableblock halign-left valign-top" > Observations</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Bcrypt</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><span class="monospaced">byddy.hashers.bcrypt</span></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Recommended</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Pbkdf2</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><span class="monospaced">buddy.hashers.pbkdf2</span></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Recommended</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Scrypt</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><span class="monospaced">buddy.hashers.scrypt</span></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Recommended</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">sha256</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><span class="monospaced">buddy.hashers.sha256</span></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Not recommended</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">md5</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><span class="monospaced">buddy.hashers.md5</span></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Broken! Not Recommended</p></td>
</tr>
</tbody>
</table>
<div class="paragraph"><p>The hashers  consist in two functions: <span class="monospaced">make-password</span> and <span class="monospaced">check-password</span>.</p></div>
<div class="paragraph"><p>The purpose of these functions is obvious: creating a new password,
and verifying incoming plain text password with previously created
hash.</p></div>
<div class="listingblock">
<div class="title">Example of creating and verifying a new hash</div>
<div class="content"><div class="highlight"><pre><span class="p">(</span><span class="nf">require</span> <span class="o">&#39;</span><span class="p">[</span><span class="nv">buddy.hashers.bcrypt</span> <span class="ss">:as</span> <span class="nv">hs</span><span class="p">])</span>

<span class="p">(</span><span class="k">def </span><span class="nv">myhash</span> <span class="p">(</span><span class="nf">hs/make-password</span> <span class="s">&quot;secretpassword&quot;</span><span class="p">))</span>
<span class="p">(</span><span class="k">def </span><span class="nv">ok</span> <span class="p">(</span><span class="nf">hs/check-password</span> <span class="s">&quot;secretpassword&quot;</span> <span class="nv">myhash</span><span class="p">))</span>

<span class="c1">;; ok var reference should contain true</span>
</pre></div></div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph"><p><span class="monospaced">make-password</span> accept distinct parameters depending on hasher implementation and all functions
works with strings instead of bytes (unlike cryptographyc hash functions).</p></div>
</td>
</tr></table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_web_extensions">6. Web extensions</h2>
<div class="sectionbody">
<div class="paragraph"><p>Additionaly, buddy commes with web libraries support for authentication and authorization. It
mainly works with ring/compojure combination but in future can be extended for work with other
libraries</p></div>
<div class="sect2">
<h3 id="_authentication">6.1. Authentication</h3>
<div class="paragraph"><p><em>buddy</em> comes with an authentication system. It is implemented with
protocols that can be used to implement your own authentication
backend if one of the now supported backends by buddy does not satisfy
your needs.</p></div>
<div class="paragraph"><p>Here is a list of built-in authentication backends:</p></div>
<div class="ulist"><ul>
<li>
<p>
Http Basic
</p>
</li>
<li>
<p>
Session
</p>
</li>
<li>
<p>
Token
</p>
</li>
<li>
<p>
SignedToken (using previously explained signing framework).
</p>
</li>
</ul></div>
<div class="sect3">
<h4 id="_http_basic">6.1.1. HTTP Basic</h4>
<div class="paragraph"><p>The HTTP Basic authentication backend is one of the simplest/insecure
authentication systems, but it works well as a first introduction of
authentication with <em>buddy</em>.</p></div>
<div class="listingblock">
<div class="title">Simple handler definition</div>
<div class="content"><div class="highlight"><pre><span class="p">(</span><span class="nf">require</span> <span class="o">&#39;</span><span class="p">[</span><span class="nv">buddy.auth</span> <span class="ss">:refer</span> <span class="p">(</span><span class="nf">authenticated?</span><span class="p">)])</span>
<span class="p">(</span><span class="nf">require</span> <span class="o">&#39;</span><span class="p">[</span><span class="nv">ring.util.response</span> <span class="ss">:refer</span> <span class="p">(</span><span class="nf">response</span><span class="p">)])</span>

<span class="c1">;; Simple ring handler. This can also be a compojure routes handler</span>
<span class="c1">;; or anything else compatible with ring middlewares.</span>
<span class="p">(</span><span class="kd">defn </span><span class="nv">handler</span>
  <span class="p">[</span><span class="nv">request</span><span class="p">]</span>
  <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nf">authenticated?</span> <span class="nv">request</span><span class="p">)</span>
    <span class="p">(</span><span class="nf">response</span> <span class="p">(</span><span class="nf">format</span> <span class="s">&quot;Hello %s&quot;</span> <span class="p">(</span><span class="ss">:identity</span> <span class="nv">request</span><span class="p">)))</span>
    <span class="p">(</span><span class="nf">response</span> <span class="s">&quot;Hello Anonymous&quot;</span><span class="p">)))</span>
</pre></div></div></div>
<div class="listingblock">
<div class="title">Middleware usage example</div>
<div class="content"><div class="highlight"><pre><span class="c1">;; Import middleware function and backend constructor</span>

<span class="p">(</span><span class="nf">require</span> <span class="o">&#39;</span><span class="p">[</span><span class="nv">buddy.auth.backends.httpbasic</span> <span class="ss">:refer</span> <span class="p">[</span><span class="nv">http-basic-backend</span><span class="p">]])</span>
<span class="p">(</span><span class="nf">require</span> <span class="o">&#39;</span><span class="p">[</span><span class="nv">buddy.auth.middleware</span> <span class="ss">:refer</span> <span class="p">[</span><span class="nv">wrap-authentication</span><span class="p">]])</span>

<span class="c1">;; This function always receives request and authdata, authdata</span>
<span class="c1">;; can vary with other backends. For http basic backend, authdata</span>
<span class="c1">;; parameter has the form {:username xxxx :password yyyy}</span>
<span class="c1">;;</span>
<span class="c1">;; This function should return a non-nil value that</span>
<span class="c1">;; is automatically stored on :identity key on request</span>
<span class="c1">;; If it returns nil, a request is considered unauthenticated.</span>

<span class="p">(</span><span class="kd">defn </span><span class="nv">my-authfn</span>
  <span class="p">[</span><span class="nv">request</span>, <span class="nv">authdata</span><span class="p">]</span>
  <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">username</span> <span class="p">(</span><span class="ss">:username</span> <span class="nv">authdata</span><span class="p">)</span>
        <span class="nv">password</span> <span class="p">(</span><span class="ss">:password</span> <span class="nv">authdata</span><span class="p">)]</span>
    <span class="p">(</span><span class="nf">search-user-on-db</span> <span class="nv">username</span> <span class="nv">password</span><span class="p">)))</span>

<span class="c1">;; Define the main handler with *app* name wrapping it</span>
<span class="c1">;; with authentication middleware using an instance of</span>
<span class="c1">;; just created http-basic backend.</span>

<span class="p">(</span><span class="k">def </span><span class="nv">app</span>
  <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">backend</span> <span class="p">(</span><span class="nf">http-basic-backend</span> <span class="ss">:realm</span> <span class="s">&quot;MyApi&quot;</span> <span class="ss">:authfn</span> <span class="nv">my-authfn</span><span class="p">)]</span>
    <span class="p">(</span><span class="nf">wrap-authentication</span> <span class="nv">handler</span> <span class="nv">backend</span><span class="p">)))</span>
</pre></div></div></div>
</div>
<div class="sect3">
<h4 id="_session">6.1.2. Session</h4>
<div class="paragraph"><p>The session-authenticated backend has the simplest implementation, but
requires session middleware to work properly.</p></div>
<div class="paragraph"><p>Unlike the previous auth backend, this does not requires authfn,
because it relies on <span class="monospaced">:identity</span> key on session and trust it. If a
session contains the <span class="monospaced">:identity</span> key with logical true value it
identifies the current request as authenticated and put <span class="monospaced">:identity</span>
key on request map.</p></div>
<div class="paragraph"><p>See <a href="#examples">examples section</a> for complete examples for this backend.</p></div>
</div>
<div class="sect3">
<h4 id="_token">6.1.3. Token</h4>
<div class="paragraph"><p>It works as expected, parses token and call function for authenticate the token. Nothing
more.</p></div>
</div>
<div class="sect3">
<h4 id="_signed_token">6.1.4. Signed Token</h4>
<div class="paragraph"><p>This works similar to <strong>session</strong> and <strong>token</strong> backends, but it uses a signing framework explained in a
first section of this document.</p></div>
<div class="paragraph"><p>Extracts token from header using same functions as <strong>token</strong> backend but instad of call a function
for authorize or trust a session key, it try verify the incoming token and if it success, the signed
data are trustly set to <span class="monospaced">:identity</span> key on request.</p></div>
<div class="paragraph"><p>See <a href="#examples">examples section</a> for complete examples for this backend.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_authorization">6.2. Authorization</h3>
<div class="paragraph"><p><em>buddy</em> also comes with an authorization system.</p></div>
<div class="paragraph"><p>The authorization system is splited in two parts:</p></div>
<div class="ulist"><ul>
<li>
<p>
generic authorization system using exceptions for fast return and unauthorized-handler function
  for handle unauthorized requsts.
</p>
</li>
<li>
<p>
access rules system based on matching urls using regular expressions and apply some
  rules handlers. The idea is taken from <span class="monospaced">lib-noir</span> but with slighty distinct approach.
</p>
</li>
</ul></div>
<div class="sect3">
<h4 id="_generic_authorization">6.2.1. Generic authorization</h4>
<div class="paragraph"><p>This authorization system encapsulates your handlers/controllers in one try/catch block
catching only notauthorized exceptions. So spliting unauthorized request handling code from
your handlers/controllers in a separate function. Moreover, permits fast return when
not authorized request is detected.</p></div>
<div class="paragraph"><p>Like authentication system, authorization is also implemented using protocols. Taking advantage of
it, all builtin authentication backends also implements this authorization protocol (<span class="monospaced">IAuthorization</span>).</p></div>
<div class="paragraph"><p>Some authentication backends require specific behavior in the
authorization layer (like http-basic which should return
<span class="monospaced">WWW-Authenticate</span> header when request is unauthorized) and by
default, all backends come with an implementation. You can overwrite
the default behavior by passing your own exception handler through the
<span class="monospaced">:unauthorized-handler</span> keyword parameter in the backend constructor.</p></div>
<div class="paragraph"><p>Below is a complete example setting up a basic/generic authorization
system for your ring compatible web application:</p></div>
<div class="listingblock">
<div class="title">Defining unauthorized handler</div>
<div class="content"><div class="highlight"><pre><span class="p">(</span><span class="nf">require</span> <span class="o">&#39;</span><span class="p">[</span><span class="nv">buddy.auth</span> <span class="ss">:refer</span> <span class="p">[</span><span class="nv">authenticated?</span> <span class="nv">throw-unauthorized</span><span class="p">]])</span>
<span class="p">(</span><span class="nf">require</span> <span class="o">&#39;</span><span class="p">[</span><span class="nv">ring.util.response</span> <span class="ss">:refer</span> <span class="p">(</span><span class="nf">response</span> <span class="nv">redirect</span><span class="p">)])</span>

<span class="c1">;; An unauthorized-handler is executed when `buddy.auth/throw-unauthorized`</span>
<span class="c1">;; exception is raised and captured by genric authorization middleware:</span>
<span class="c1">;; `wrap-authorization`. It always receives the current request and metadata</span>
<span class="c1">;; hash-map that in most cases is empty.</span>

<span class="p">(</span><span class="kd">defn </span><span class="nv">my-unauthorized-handler</span>
  <span class="p">[</span><span class="nv">request</span> <span class="nv">metadata</span><span class="p">]</span>
  <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nf">authenticated?</span> <span class="nv">request</span><span class="p">)</span>
    <span class="p">(</span><span class="nf">response</span> <span class="s">&quot;Permission denied&quot;</span><span class="p">)</span>
    <span class="p">(</span><span class="nf">redirect</span> <span class="s">&quot;/login&quot;</span><span class="p">)))</span>
</pre></div></div></div>
<div class="listingblock">
<div class="title">Defining a simple handler that raises unauthorized exception when user is not authenticated</div>
<div class="content"><div class="highlight"><pre><span class="c1">;; This is a simple ring compatible handler</span>
<span class="p">(</span><span class="kd">defn </span><span class="nv">handler</span>
  <span class="p">[</span><span class="nv">request</span><span class="p">]</span>
  <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nf">authenticated?</span><span class="p">)</span>
    <span class="p">(</span><span class="nf">response</span> <span class="s">&quot;Hello World&quot;</span><span class="p">)</span>
    <span class="p">(</span><span class="nf">throw-unauthorized</span><span class="p">)))</span>
</pre></div></div></div>
<div class="listingblock">
<div class="title">Define the final handler</div>
<div class="content"><div class="highlight"><pre><span class="p">(</span><span class="nf">require</span> <span class="o">&#39;</span><span class="p">[</span><span class="nv">buddy.auth.backends.httpbasic</span> <span class="ss">:refer</span> <span class="p">[</span><span class="nv">http-basic-backend</span><span class="p">]])</span>
<span class="p">(</span><span class="nf">require</span> <span class="o">&#39;</span><span class="p">[</span><span class="nv">buddy.auth.middleware</span> <span class="ss">:refer</span> <span class="p">[</span><span class="nv">wrap-authentication</span> <span class="nv">wrap-authorization</span><span class="p">]])</span>

<span class="c1">;; Define the final handler wrapping it on authentication and</span>
<span class="c1">;; authorization handler using the same backend and overwriting</span>
<span class="c1">;; the default unathorized request behavior with own, previously</span>
<span class="c1">;; defined function</span>

<span class="p">(</span><span class="k">def </span><span class="nv">app</span>
  <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">backend</span> <span class="p">(</span><span class="nf">http-basic-backend</span>
                 <span class="ss">:realm</span> <span class="s">&quot;API&quot;</span>
                 <span class="ss">:authfn</span> <span class="nv">my-auth-fn</span>
                 <span class="ss">:unauthorized-handler</span> <span class="nv">my-unauthorized-handler</span><span class="p">)]</span>
    <span class="p">(</span><span class="nb">-&gt; </span><span class="nv">handler</span>
        <span class="p">(</span><span class="nf">wrap-authentication</span> <span class="nv">backend</span><span class="p">)</span>
        <span class="p">(</span><span class="nf">wrap-authorization</span> <span class="nv">backend</span><span class="p">))))</span>
</pre></div></div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">If you want know how it really works, see <a href="#how-it-works">How it works</a> section or
take a look on examples.</td>
</tr></table>
</div>
</div>
<div class="sect3">
<h4 id="_access_rules_system">6.2.2. Access Rules System</h4>
<div class="sect4">
<h5 id="_introduction_2">Introduction</h5>
<div class="paragraph"><p>The access rules are another part of the authorization system, and
consist of a list of rules for one or more uri&#8217;s using regular
expressions. One rule consists of a regular expression with its
associated handler (function) for authorization logic.</p></div>
<div class="listingblock">
<div class="title">Simple rule example</div>
<div class="content"><div class="highlight"><pre><span class="p">{</span><span class="ss">:pattern</span> <span class="o">#</span><span class="s">&quot;^/admin/.*&quot;</span>
 <span class="ss">:handler</span> <span class="nv">admin-access</span><span class="p">}</span>
</pre></div></div></div>
<div class="paragraph"><p>Having the <span class="monospaced">admin-access</span> function like this:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="p">(</span><span class="k">def </span><span class="nv">users</span> <span class="p">{</span><span class="ss">:niwibe</span> <span class="p">{</span><span class="ss">:roles</span> <span class="o">#</span><span class="p">{</span><span class="ss">:admin</span><span class="p">}}</span>
            <span class="ss">:pepe</span> <span class="p">{</span><span class="ss">:roles</span> <span class="o">#</span><span class="p">{</span><span class="ss">:user</span><span class="p">}}})</span>

<span class="p">(</span><span class="kd">defn </span><span class="nv">admin-access</span>
  <span class="p">[</span><span class="nv">request</span><span class="p">]</span>
  <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nb">identity </span><span class="p">(</span><span class="ss">:identity</span> <span class="nv">request</span><span class="p">)]</span>
    <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nb">nil? </span><span class="nv">identity</span><span class="p">)</span> <span class="nv">false</span>
      <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">roles</span> <span class="p">(</span><span class="nb">-&gt; identity </span><span class="nv">users</span> <span class="ss">:roles</span><span class="p">)]</span>
        <span class="p">(</span><span class="nb">boolean </span><span class="p">(</span><span class="nf">roles</span> <span class="ss">:admin</span><span class="p">))))))</span>
</pre></div></div></div>
<div class="paragraph"><p>The handler function should receive a request and return true, false
or throw unauthorized exception. Throwing unauthorized exception is a
fast return method and no other handler is executed before it (only if
handler is wrapped with <span class="monospaced">wrap-authorization</span> middleware).</p></div>
<div class="paragraph"><p>In the previous example we have seen a simple handler associated with
one regular expression, but <em>buddy</em> access rules system allows combine
more handlers using logical <span class="monospaced">:and</span> &amp; <span class="monospaced">:or</span> combinators with nesting
support.</p></div>
<div class="paragraph"><p>For example, suppose you want to allow access to a set of urls only to
operators or administrators:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="p">{</span><span class="ss">:pattern</span> <span class="o">#</span><span class="s">&quot;^/admin/.*&quot;</span>
 <span class="ss">:handler</span> <span class="p">{</span><span class="ss">:or</span> <span class="p">[</span><span class="nv">admin-access</span> <span class="nv">operator-access</span><span class="p">]}}</span>
</pre></div></div></div>
<div class="paragraph"><p>Or allow only when a user has both roles, operator and administrator:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="p">{</span><span class="ss">:pattern</span> <span class="o">#</span><span class="s">&quot;^/admin/.*&quot;</span>
 <span class="ss">:handler</span> <span class="p">{</span><span class="ss">:and</span> <span class="p">[</span><span class="nv">admin-access</span> <span class="nv">operator-access</span><span class="p">]}}</span>
</pre></div></div></div>
<div class="paragraph"><p>Even more, you want to only allow read-write access to administrators
and operators, and read-only access to any authenticated user:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="p">{</span><span class="ss">:pattern</span> <span class="o">#</span><span class="s">&quot;^/admin/.*&quot;</span>
 <span class="ss">:handler</span> <span class="p">{</span><span class="ss">:or</span> <span class="p">[</span><span class="nv">admin-access</span> <span class="nv">operator-access</span>
               <span class="p">{</span><span class="ss">:and</span> <span class="p">[</span><span class="nv">safemethod-access</span> <span class="nv">authenticated-access</span><span class="p">]}]}}</span>
</pre></div></div></div>
</div>
<div class="sect4">
<h5 id="_usage">Usage</h5>
<div class="paragraph"><p>The access rules system is flexible and adapting it is very simple for
many use cases.</p></div>
<div class="paragraph"><p>The simplest way to use access rules is by using the
<span class="monospaced">wrap-access-rules</span> middleware with an ordered vector of
rules. <strong>Important:</strong> rules are evaluated in order, therefore, put less
restrictive regular expression at the end.</p></div>
<div class="listingblock">
<div class="title">Define a list of rules</div>
<div class="content"><div class="highlight"><pre><span class="c1">;; Rules handlers used on this example are omited for code clarity</span>
<span class="c1">;; and them repsents a authorization logic for its name.</span>

<span class="p">(</span><span class="k">def </span><span class="nv">rules</span> <span class="p">[{</span><span class="ss">:pattern</span> <span class="o">#</span><span class="s">&quot;^/admin/.*&quot;</span>
             <span class="ss">:handler</span> <span class="p">{</span><span class="ss">:or</span> <span class="p">[</span><span class="nv">admin-access</span> <span class="nv">operator-access</span><span class="p">]}}</span>
            <span class="p">{</span><span class="ss">:pattern</span> <span class="o">#</span><span class="s">&quot;^/login$&quot;</span>
             <span class="ss">:handler</span> <span class="nv">any-access</span><span class="p">}</span>
            <span class="p">{</span><span class="ss">:pattern</span> <span class="o">#</span><span class="s">&quot;^/.*&quot;</span>
             <span class="ss">:handler</span> <span class="nv">authenticated-access</span><span class="p">}])</span>
</pre></div></div></div>
<div class="listingblock">
<div class="title">Define default behavior for not authorized requests</div>
<div class="content"><div class="highlight"><pre><span class="c1">;; This functions works like default ring compatible handler</span>
<span class="c1">;; and should implement the default behavior for request</span>
<span class="c1">;; that are not authorized by any defined rule</span>

<span class="p">(</span><span class="kd">defn </span><span class="nv">reject-handler</span>
  <span class="p">[</span><span class="nv">request</span><span class="p">]</span>
  <span class="p">{</span><span class="ss">:status</span> <span class="mi">403</span>
   <span class="ss">:headers</span> <span class="p">{}</span>
   <span class="ss">:body</span> <span class="s">&quot;Not authorized&quot;</span><span class="p">})</span>
</pre></div></div></div>
<div class="listingblock">
<div class="title">Wrap your handler with access rules (and run with jetty as example)</div>
<div class="content"><div class="highlight"><pre><span class="p">(</span><span class="kd">defn </span><span class="nv">-main</span>
  <span class="p">[</span><span class="o">&amp;</span> <span class="nv">args</span><span class="p">]</span>
  <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">app</span> <span class="p">(</span><span class="nf">wrap-access-rules</span> <span class="nv">your-app-handler</span>
                               <span class="ss">:rules</span> <span class="nv">rules</span>
                               <span class="ss">:reject-handler</span> <span class="nv">reject-handler</span><span class="p">))]</span>
    <span class="p">(</span><span class="nf">run-jetty</span> <span class="nv">app</span> <span class="p">{</span><span class="ss">:port</span> <span class="mi">9090</span><span class="p">}))</span>
</pre></div></div></div>
<div class="paragraph"><p>An unauthorized exception is raised if no reject handler is
specified. These exceptions can be captured by generic authorization
middleware.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">The current request uri not match any regular expresion, the default policy enter in
action. The default policy in <em>buddy</em> is <span class="monospaced">:allow</span> but you can change it to <span class="monospaced">:reject</span>
using keyword <span class="monospaced">:policy</span> on wrap-access-rules middleware.</td>
</tr></table>
</div>
<div class="paragraph"><p>An other way to use access rules is using <span class="monospaced">buddy.auth.accessrules/restrict</span>
handler decorator that allows assign some rules to concrete handlers omiting
any url matching.</p></div>
<div class="paragraph"><p>The usage of it can be easy, as shown with Compojure routes:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="p">(</span><span class="nf">require</span> <span class="o">&#39;</span><span class="p">[</span><span class="nv">buddy.auth.accessrules</span> <span class="ss">:refer</span> <span class="p">[</span><span class="nv">restrict</span><span class="p">]])</span>

<span class="p">(</span><span class="nf">defroutes</span> <span class="nv">app</span>
  <span class="p">(</span><span class="nf">GET</span> <span class="s">&quot;/&quot;</span> <span class="p">[]</span> <span class="p">(</span><span class="nf">restrict</span> <span class="nv">my-home-ctrl</span>
                        <span class="c1">;; Mandatory parameter</span>
                        <span class="ss">:rule</span> <span class="nv">user-access</span>
                        <span class="c1">;; Optional parameter, in case if not passed</span>
                        <span class="c1">;; default is used (defined by `wrap-access-rules`</span>
                        <span class="c1">;; middleware) or `throw-unauthorized` is raised</span>
                        <span class="c1">;; if default isn&#39;t available</span>
                        <span class="ss">:reject-handler</span> <span class="nv">reject-handler</span><span class="p">))</span>
  <span class="p">(</span><span class="nf">GET</span> <span class="s">&quot;/admin&quot;</span> <span class="p">(</span><span class="nf">restrict</span> <span class="nv">my-admin-ctrl</span>
                          <span class="ss">:rule</span> <span class="nv">admin-access</span><span class="p">)))</span>
</pre></div></div></div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_advanced_usage_3">7. Advanced Usage</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="how-it-works">7.1. How Auth Works</h3>
<div class="paragraph"><p>Each backend implements two protocols: <span class="monospaced">IAuthentication</span> and <span class="monospaced">IAuthorization</span>.</p></div>
<div class="paragraph"><p><strong>IAuthentication</strong> provides two functions: <span class="monospaced">parse</span> and <span class="monospaced">authenticate</span>
and is automatically handled with <span class="monospaced">wrap-authentication</span> ring
middleware. This is an example flow for the http basic backend:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
Received request is passed to <span class="monospaced">parse</span> function. This function extracts the <span class="monospaced">Authorization</span>
   header, decodes a base64 encoded string and returns Clojure map with <span class="monospaced">:username</span> and <span class="monospaced">:password</span>
   keys. If a parse error occured, it returns nil.
</p>
</li>
<li>
<p>
If the previous step parsed the token successfully, <span class="monospaced">authenticate</span> is called with current
   request and parsed data from previous step. <span class="monospaced">authenticate</span> can delegate authentication
   to user defined function passed as <span class="monospaced">:authfn</span> parameter to backend constructor.
   <span class="monospaced">authenticate</span> should return a request with <span class="monospaced">:identity</span> key assigned to nil or any other
   value. All requests with <span class="monospaced">:identity</span> key with nil value are considered not authenticated.
</p>
</li>
<li>
<p>
User handler is called.
</p>
</li>
</ol></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="ulist"><ul>
<li>
<p>
<span class="monospaced">parse</span> function can return valid response, in that case response is returned inmediatel
  ignoring user handler.
</p>
</li>
<li>
<p>
if <span class="monospaced">parse</span> function returns nil, <span class="monospaced">authenticate</span> function is ignored and user handler is
  called directly.
</p>
</li>
<li>
<p>
<span class="monospaced">authenticate</span> also can return a valid response, in these case it has same behavior that
  with <span class="monospaced">parse</span> function.
</p>
</li>
</ul></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p><strong>IAuthorization</strong> provides <span class="monospaced">handle-unauthorized</span> function. Each backend implements it default
behavior but it can be overwritted with user defined function, passed on <span class="monospaced">:handle-unauthorized</span>
keyword parameter to backend constructor. It always should return a valid response.</p></div>
<div class="paragraph"><p>Authorization is handled automatically with <span class="monospaced">wrap-authorization</span> ring middleware. It wraps
all request in try/catch block for intercept only authorization exception.</p></div>
<div class="paragraph"><p>This is a flow that follows authorization middleware:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
User handler is wrapped in try/catch block and executed.
</p>
</li>
<li>
<p>
Not authorized exception is raised with <span class="monospaced">buddy.auth/throw-unauthorized</span> function from
   any part of your handler.
</p>
</li>
<li>
<p>
handle-unauthorized is executed of your backend, if user has specified it own function,
   the user defined function is executed else, default behavior is executed.
</p>
</li>
</ol></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_examples">8. Examples</h2>
<div class="sectionbody">
<div class="paragraph"><p><em>buddy</em> comes with some examples for helping a new user understand how
it works. All examples are available in the <span class="monospaced">examples/</span> directory.</p></div>
<div class="paragraph"><p>At the moment, two examples are available:</p></div>
<div class="ulist"><ul>
<li>
<p>
<a href="https://github.com/niwibe/buddy/tree/master/examples/sessionexample">Use session backend as authentication and authorization.</a>
</p>
</li>
<li>
<p>
<a href="https://github.com/niwibe/buddy/tree/master/examples/oauthexample">Use session backend with oauth2 using Github api.</a>
</p>
</li>
</ul></div>
<div class="paragraph"><p>To run examples, you should be in the project&#8217;s root directory.
Execute <span class="monospaced">lein with-profile examplename run</span> where examplename can be
<span class="monospaced">sessionexample</span> or <span class="monospaced">oauthexample</span>.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_how_to_contribute">9. How to contribute</h2>
<div class="sectionbody">
<div class="paragraph"><p><em>buddy</em> does not have many restrictions for contributing.</p></div>
<div class="paragraph"><p><strong>For Bugfix</strong>:</p></div>
<div class="ulist"><ul>
<li>
<p>
Fork github repo.
</p>
</li>
<li>
<p>
Fix a bug/typo on new branch.
</p>
</li>
<li>
<p>
Make a pull-request to master.
</p>
</li>
</ul></div>
<div class="paragraph"><p><strong>For New feature</strong>:</p></div>
<div class="ulist"><ul>
<li>
<p>
Open a new issue with new feature purpose.
</p>
</li>
<li>
<p>
If it is accepted, follow same steps as "bugfix".
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect1">
<h2 id="_faq">10. FAQ</h2>
<div class="sectionbody">
<div class="paragraph"><p><strong>Buddy is a security library/framework?</strong>
Yes and No. I don&#8217;t like call "security" library because security represents a very generic
concepts and can contain a lot of things. Buddy is target to authentication, authorization and signing.</p></div>
<div class="paragraph"><p><strong>How can I use <em>buddy</em> with <a href="http://clojure-liberator.github.io/liberator/">liberator</a>?</strong></p></div>
<div class="paragraph"><p>By design, <em>buddy</em> has authorization and authentication well
separated. This helps a lot if you want use only one part of it (ex:
authentication only) without including the other.</p></div>
<div class="paragraph"><p>The best combination is to use <em>buddy</em>'s authentication middleware
with liberator authorization endpoints.</p></div>
<div class="paragraph"><p><strong>Buddy will support pgp?</strong></p></div>
<div class="paragraph"><p>Surely not! Because there is already exists one good <a href="https://github.com/greglook/clj-pgp">library for that</a>.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_license">11. License</h2>
<div class="sectionbody">
<div class="listingblock">
<div class="content"><div class="highlight"><pre>Copyright 2014 Andrey Antukh &lt;niwi@niwi.be&gt;

Licensed under the Apache License, Version 2.0 (the &quot;License&quot;)
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
</pre></div></div></div>
</div>
</div>
</div>
<div id="footnotes"><hr></div>
<div id="footer">
<div id="footer-text">
Version 0.1.2<br>
Last updated 2014-05-02 21:23:47 CEST
</div>
</div>
</body>
</html>
