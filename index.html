<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="generator" content="AsciiDoc 8.6.9">
<title>buddy documentation</title>
<link rel="stylesheet" href="static/niwi.css" type="text/css">
<link rel="stylesheet" href="static/pygments.css" type="text/css">


<script type="text/javascript" src="static/asciidoc.js"></script>
<script type="text/javascript" src="static/niwi.js"></script>
<script type="text/javascript">
/*<![CDATA[*/
asciidoc.install(2);
/*]]>*/
</script>
</head>
<body class="article" style="max-width:800px">
<div id="header">
<h1>buddy documentation</h1>
<span id="author">Andrey Antukh,</span><br>
<span id="email" class="monospaced">&lt;<a href="mailto:niwi@niwi.be">niwi@niwi.be</a>&gt;</span><br>
<span id="revnumber">version 0.1.0,</span>
<span id="revdate">2014-01-19</span>
<div id="toc">
  <div id="toctitle">Table of Contents</div>
  <noscript><p><b>JavaScript must be enabled in your browser to display the table of contents.</b></p></noscript>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="_introduction">1. Introduction</h2>
<div class="sectionbody">
<div class="paragraph"><p><em>buddy</em> is an authentication, authorization and signing library for clojure.
It&#8217;s designed with simplicity in mind and high level framework agnostic
(it only depends on ring) following the principle of single responsability.</p></div>
<div class="paragraph"><p>Features/Libraries:</p></div>
<div class="ulist"><ul>
<li>
<p>
Modular Authentication(implemented using protocols).
</p>
</li>
<li>
<p>
Modular Generic Authorization.
</p>
</li>
<li>
<p>
Simple regular expression based access rules system.
</p>
</li>
<li>
<p>
Signing library.
</p>
</li>
<li>
<p>
Password hashers library.
</p>
</li>
</ul></div>
<div class="paragraph"><p><a href="api/index.html">Api reference documentation.</a></p></div>
<div class="sect2">
<h3 id="_philosofy">1.1. Philosofy</h3>
<div class="paragraph"><p>Five most important rules:</p></div>
<div class="ulist"><ul>
<li>
<p>
Beautiful is better than ugly.
</p>
</li>
<li>
<p>
Explicit is better than implicit.
</p>
</li>
<li>
<p>
Simple is better than complex.
</p>
</li>
<li>
<p>
Complex is better than complicated.
</p>
</li>
<li>
<p>
Readability counts.
</p>
</li>
</ul></div>
<div class="paragraph"><p>All contributions to <em>buddy</em> should keep these important rules in mind.</p></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_project_maturity">2. Project Maturity</h2>
<div class="sectionbody">
<div class="paragraph"><p><em>buddy</em> is a young project and can experiment some api changes.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_install">3. Install</h2>
<div class="sectionbody">
<div class="paragraph"><p>This section covers a installation of <em>buddy</em>.</p></div>
<div class="sect2">
<h3 id="_leiningen">3.1. Leiningen</h3>
<div class="paragraph"><p>The simplest way to use <em>buddy</em> on clojure project, is including it on dependency
vector of your <strong><em>project.clj</em></strong> file:</p></div>
<div class="listingblock">
<div class="title"><em>on project.clj</em></div>
<div class="content"><div class="highlight"><pre><span class="p">[</span><span class="nv">buddy</span> <span class="s">&quot;0.1.0-beta3&quot;</span><span class="p">]</span>
</pre></div></div></div>
</div>
<div class="sect2">
<h3 id="_maven">3.2. Maven</h3>
<div class="paragraph"><p>Also, you can use it on your projects with maven. As first step add a clojars repository:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nt">&lt;repository&gt;</span>
    <span class="nt">&lt;id&gt;</span>clojars.org<span class="nt">&lt;/id&gt;</span>
    <span class="nt">&lt;url&gt;</span>http://clojars.org/repo<span class="nt">&lt;/url&gt;</span>
<span class="nt">&lt;/repository&gt;</span>
</pre></div></div></div>
<div class="paragraph"><p>Following of buddy package dependecy:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>buddy<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>buddy<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;version&gt;</span>0.1.0-beta3<span class="nt">&lt;/version&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</pre></div></div></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_user_guide">4. User guide</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_signing">4.1. Signing</h3>
<div class="paragraph"><p>One of the main parts of <em>buddy</em> is a "Signing framework",
that is mainly based on django&#8217;s <a href="https://docs.djangoproject.com/en/1.6/topics/signing/">Cryptographic signing</a>
library.</p></div>
<div class="paragraph"><p>That can be used for several purposes:</p></div>
<div class="ulist"><ul>
<li>
<p>
Safely store session data on cookie instead on a database. (It prevents that other can change a session content)
</p>
</li>
<li>
<p>
Self contained token generation for use it on completelly stateless token based authentication.
</p>
</li>
</ul></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">this library is used by one of authentication backends for implement token based stateless authentication.</td>
</tr></table>
</div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">hmac+sha256 is used for sign all data.</td>
</tr></table>
</div>
<div class="sect3">
<h4 id="_using_low_level_api">4.1.1. Using low level api</h4>
<div class="paragraph"><p><em>buddy&#8217;s</em> signing functions live in <strong><span class="monospaced">buddy.crypto.signing</span></strong> namespace and it consists on four
functions: <span class="monospaced">sign</span>, <span class="monospaced">unsign</span>, <span class="monospaced">loads</span> and <span class="monospaced">dumps</span>.</p></div>
<div class="paragraph"><p><span class="monospaced">sign</span> and <span class="monospaced">unsign</span> functions represents a low level api and them works with
strings as primary data.</p></div>
<div class="listingblock">
<div class="title">Unsigning previously signed data</div>
<div class="content"><div class="highlight"><pre><span class="p">(</span><span class="nf">require</span> <span class="o">&#39;</span><span class="p">[</span><span class="nv">buddy.crypto.signing</span> <span class="ss">:refer</span> <span class="p">[</span><span class="nv">sign</span> <span class="nv">unsign</span><span class="p">]])</span>

<span class="c1">;; Sign data</span>
<span class="p">(</span><span class="k">def </span><span class="nv">signed-data</span> <span class="p">(</span><span class="nf">sign</span> <span class="s">&quot;mystring&quot;</span> <span class="s">&quot;my-secret-key&quot;</span><span class="p">))</span>

<span class="c1">;; signed-data should contain string similtar to:</span>
<span class="c1">;; &quot;mystring:f08dd937a438f43639d34a345910148cb933ea8ea0c2c306e8733e0255677e3d:MTM...&quot;</span>

<span class="c1">;; Unsign previosly signed data</span>
<span class="p">(</span><span class="k">def </span><span class="nv">unsigned-data</span> <span class="p">(</span><span class="nf">unsign</span> <span class="nv">signed-data</span> <span class="s">&quot;my-secret-key&quot;</span><span class="p">))</span>

<span class="c1">;; unsigned-data should contain a original string: &quot;mystring&quot;</span>
</pre></div></div></div>
<div class="paragraph"><p>Signing process consists on concat signature on the end of the original string,
separating the signature with predefined separator (default ":" char). Signature
consists on timestamped hmac signature. <strong>Timestamp</strong> can be used for invalidate by
time some signed data.</p></div>
<div class="listingblock">
<div class="title">Invalidate signed data using timestamp</div>
<div class="content"><div class="highlight"><pre><span class="c1">;; Unsign with maxago (15min)</span>
<span class="p">(</span><span class="k">def </span><span class="nv">unsigned-data</span> <span class="p">(</span><span class="nf">unsign</span> <span class="nv">signed-data</span> <span class="s">&quot;my-secret-key&quot;</span> <span class="p">{</span><span class="ss">:maxago</span> <span class="p">(</span><span class="nb">* </span><span class="mi">60</span> <span class="mi">15</span> <span class="mi">1000</span><span class="p">)}))</span>

<span class="c1">;; unsigned-data should contain nil value if a signed date is older than 15 min.</span>
</pre></div></div></div>
</div>
<div class="sect3">
<h4 id="_protecting_complex_data_structures">4.1.2. Protecting complex data structures</h4>
<div class="paragraph"><p>If you wish to protect a clojure native data structure (hash-map, hash-set, list, vector, etc&#8230;)
you can do so using the signing <strong><span class="monospaced">dumps</span></strong> and <strong><span class="monospaced">loads</span></strong> functions. Them accepts same parameters that
their friends (<span class="monospaced">sign</span> and <span class="monospaced">unsign</span>) but also can sign more complex data.</p></div>
<div class="listingblock">
<div class="title">Sign/Unsign clojure hash-map</div>
<div class="content"><div class="highlight"><pre><span class="p">(</span><span class="nf">require</span> <span class="o">&#39;</span><span class="p">[</span><span class="nv">buddy.crypto.signing</span> <span class="ss">:refer</span> <span class="p">[</span><span class="nv">dumps</span> <span class="nv">loads</span><span class="p">]])</span>

<span class="c1">;; Sign data</span>
<span class="p">(</span><span class="k">def </span><span class="nv">signed-data</span> <span class="p">(</span><span class="nf">dumps</span> <span class="p">{</span><span class="ss">:userid</span> <span class="mi">1</span><span class="p">}</span> <span class="s">&quot;my-secret-key&quot;</span><span class="p">))</span>

<span class="c1">;; signed-data should contain string similar to:</span>
<span class="c1">;; &quot;TlBZARlgGwAAAAIOAAAABnVzZXJpZCsAAAAAAAAAAQ:59d9e8063ad80f6abd3092b45857810b10f5...&quot;</span>

<span class="c1">;; Unsign previosly signed data</span>
<span class="p">(</span><span class="k">def </span><span class="nv">unsigned-data</span> <span class="p">(</span><span class="nf">loads</span> <span class="nv">signed-data</span> <span class="s">&quot;my-secret-key&quot;</span><span class="p">))</span>

<span class="c1">;; unsigned-data should contain a original map: {:userid 1}</span>
</pre></div></div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">it uses a clojure serialization library <a href="https://github.com/ptaoussanis/nippy">Nippy</a></td>
</tr></table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_hashers">4.2. Hashers</h3>
<div class="paragraph"><p>An other main part of good authentication/authorization library is give you some facilities
for generate secure passwords. <em>buddy</em> comes with few functions for generate and verify passwords
using widely used password derivation algorithms like bcrypt and pbkdf2(with sha256).</p></div>
<div class="paragraph"><p><em>buddy</em> hashers lives on *<span class="monospaced">buddy.crypto.hashers.*</span> namespace and usually consists on two functions:
<span class="monospaced">make-password</span> and <span class="monospaced">check-password</span>.</p></div>
<div class="paragraph"><p>The purpose of these functions is obvious: creating new password, and verify incoming plain text
password with previously created password hash.</p></div>
<div class="listingblock">
<div class="title">Example create new hash and verify it</div>
<div class="content"><div class="highlight"><pre><span class="p">(</span><span class="nf">require</span> <span class="o">&#39;</span><span class="p">[</span><span class="nv">buddy.crypto.hashers.bcrypt</span> <span class="ss">:as</span> <span class="nv">hs</span><span class="p">])</span>

<span class="p">(</span><span class="k">def </span><span class="nv">myhash</span> <span class="p">(</span><span class="nf">hs/make-password</span> <span class="s">&quot;secretpassword&quot;</span><span class="p">))</span>
<span class="p">(</span><span class="k">def </span><span class="nv">ok</span> <span class="p">(</span><span class="nf">hs/check-password</span> <span class="s">&quot;secretpassword&quot;</span> <span class="nv">myhash</span><span class="p">))</span>

<span class="c1">;; ok var reference should contain true</span>
</pre></div></div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content"><span class="monospaced">make-password</span> accept distinct parameters depending on hasher implementation.</td>
</tr></table>
</div>
<div class="paragraph"><p>In previous example we use <strong>bcrypt</strong> hasher but <em>buddy</em> also support many other
hasher algorithm by default.</p></div>
<div class="paragraph"><p>This is a complete list of implemented hashers:</p></div>
<div class="ulist"><ul>
<li>
<p>
<span class="monospaced">buddy.crypto.hashers.pbkdf2</span> (implements pbkdf2 with sha256)
</p>
</li>
<li>
<p>
<span class="monospaced">byddy.crypto.hashers.bcrypt</span>
</p>
</li>
<li>
<p>
<span class="monospaced">buddy.crypto.hashers.sha256</span>
</p>
</li>
<li>
<p>
<span class="monospaced">buddy.crypto.hashers.md5</span>
</p>
</li>
<li>
<p>
<span class="monospaced">buddy.crypto.hashers.scrypt</span>
</p>
</li>
</ul></div>
</div>
<div class="sect2">
<h3 id="_authentication">4.3. Authentication</h3>
<div class="paragraph"><p><em>buddy</em> comes with authentication system. It is implemented with protocols, that can be used for
implement own authentication backend if one of the now supported backends by buddy does not satisfy
your needs.</p></div>
<div class="paragraph"><p>There a list of builtin authentication backends:</p></div>
<div class="ulist"><ul>
<li>
<p>
Http Basic
</p>
</li>
<li>
<p>
Session
</p>
</li>
<li>
<p>
Stateless Token (using previously explained signing framework).
</p>
</li>
</ul></div>
<div class="sect3">
<h4 id="_http_basic">4.3.1. Http Basic</h4>
<div class="paragraph"><p>Http Basic authentication backend is one of the simplest/unsecure authentication system, but works
well as first introduction of how authentication works with <em>buddy</em>.</p></div>
<div class="paragraph"><p>The main goal of <em>buddy</em> is not depending on any high level framework like (compojure, caribou, pedestal)
and it works directly as ring middleware.</p></div>
<div class="listingblock">
<div class="title">Example app: <em>main.clj</em></div>
<div class="content"><div class="highlight"><pre><span class="p">(</span><span class="kd">ns </span><span class="nv">yourapp.main</span>
  <span class="p">(</span><span class="ss">:require</span> <span class="p">[</span><span class="nv">ring.adapter.jetty</span> <span class="ss">:as</span> <span class="nv">jetty</span><span class="p">]</span>
            <span class="p">[</span><span class="nv">ring.util.response</span> <span class="ss">:refer</span> <span class="p">[</span><span class="nv">response</span><span class="p">]]</span>
            <span class="p">[</span><span class="nv">buddy.auth.backends.httpbasic</span> <span class="ss">:refer</span> <span class="p">[</span><span class="nv">http-basic-backend</span><span class="p">]]</span>
            <span class="p">[</span><span class="nv">buddy.auth.middleware</span> <span class="ss">:refer</span> <span class="p">[</span><span class="nv">wrap-authentication</span><span class="p">]]</span>
            <span class="p">[</span><span class="nv">bussy.auth</span> <span class="ss">:refer</span> <span class="p">[</span><span class="nv">authenticated?</span><span class="p">]])</span>
  <span class="p">(</span><span class="ss">:gen-class</span><span class="p">))</span>

<span class="c1">;; Simple ring handler. This also, can be a compojure routes handler</span>
<span class="c1">;; or any other while it be compatible with ring middlewares.</span>
<span class="p">(</span><span class="kd">defn </span><span class="nv">handler</span>
  <span class="p">[</span><span class="nv">request</span><span class="p">]</span>
  <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nf">authenticated?</span> <span class="nv">request</span><span class="p">)</span>
    <span class="p">(</span><span class="nf">response</span> <span class="p">(</span><span class="nf">format</span> <span class="s">&quot;Hello %s&quot;</span> <span class="p">(</span><span class="ss">:identity</span> <span class="nv">request</span><span class="p">)))</span>
    <span class="p">(</span><span class="nf">response</span> <span class="s">&quot;Hello Anonymous&quot;</span><span class="p">)))</span>

<span class="c1">;; This function always receives request and authdata, authdata</span>
<span class="c1">;; can vary with other backends. For http basic backend, authdata</span>
<span class="c1">;; parameter has this form: {:username xxxx :password yyyy}</span>
<span class="c1">;;</span>
<span class="c1">;; This function should return some not nil value that</span>
<span class="c1">;; are automatically stored on :identity key on request</span>
<span class="c1">;; If it return nil, a request is considered unautenticated.</span>
<span class="p">(</span><span class="kd">defn </span><span class="nv">my-authfn</span>
  <span class="p">[</span><span class="nv">request</span>, <span class="nv">authdata</span><span class="p">]</span>
  <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">username</span> <span class="p">(</span><span class="ss">:username</span> <span class="nv">authdata</span><span class="p">)</span>
        <span class="nv">password</span> <span class="p">(</span><span class="ss">:password</span> <span class="nv">authdata</span><span class="p">)]</span>
    <span class="p">(</span><span class="nf">cond</span>
      <span class="p">(</span><span class="nb">and </span><span class="p">(</span><span class="nb">= </span><span class="nv">username</span> <span class="s">&quot;foo&quot;</span><span class="p">)</span>
           <span class="p">(</span><span class="nb">= </span><span class="nv">password</span> <span class="s">&quot;bae&quot;</span><span class="p">))</span> <span class="ss">:myuser</span><span class="p">)))</span>

<span class="p">(</span><span class="kd">defn </span><span class="nv">-main</span>
  <span class="p">[</span><span class="o">&amp;</span> <span class="nv">args</span><span class="p">]</span>
  <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">backend</span> <span class="p">(</span><span class="nf">http-basic-backend</span> <span class="ss">:realm</span> <span class="s">&quot;MyApi&quot;</span> <span class="ss">:authfn</span> <span class="nv">my-authfn</span><span class="p">)</span>
        <span class="nv">app</span>     <span class="p">(</span><span class="nb">-&gt; </span><span class="nv">handler</span>
                    <span class="p">(</span><span class="nf">wrap-authentication</span> <span class="nv">backend</span><span class="p">))]</span>
    <span class="p">(</span><span class="nf">jetty/run-jetty</span> <span class="nv">app</span> <span class="p">{</span><span class="ss">:port</span> <span class="mi">9090</span><span class="p">}))</span>
</pre></div></div></div>
</div>
<div class="sect3">
<h4 id="_session">4.3.2. Session</h4>
<div class="paragraph"><p>Session authenticated backend has the simplest implementation comparing it with
others, but it requires session middleware for properly work.</p></div>
<div class="paragraph"><p>Unlike the previous auth backend, this does not requires authfn, because it relies on
<span class="monospaced">:identity</span> key on session  and trust it. If a session contains the <span class="monospaced">:identity</span> key with
logical true value it identifies the current request as authenticated and put <span class="monospaced">:identity</span>
key on request map.</p></div>
<div class="paragraph"><p>See <a href="#examples">examples section</a> for complete examples for this backend.</p></div>
</div>
<div class="sect3">
<h4 id="_stateless_token">4.3.3. Stateless Token</h4>
<div class="paragraph"><p>This works similar to <strong>session</strong> backend, but it uses a signing framework explained in a
first section of this document.</p></div>
<div class="paragraph"><p>Instead of trust a session key,it extracts a token from <span class="monospaced">Authorization</span> header like oauth, and
unsigns it (extracted token) using the signing framework.</p></div>
<div class="paragraph"><p>If a signature is valid, the contents of unsigned data trustly set to <span class="monospaced">:identity</span> key on request.</p></div>
<div class="paragraph"><p>See <a href="#examples">examples section</a> for complete examples for this backend.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_authorization">4.4. Authorization</h3>
<div class="paragraph"><p><em>buddy</em> also comes with authorization system.</p></div>
<div class="paragraph"><p>The authorization system is splited in two parts:</p></div>
<div class="ulist"><ul>
<li>
<p>
generic authorization system using exceptions for fast return and unauthorized-handler function
  for handle unauthorized requsts.
</p>
</li>
<li>
<p>
access rules system based on matching urls using regular expressions and apply some
  rules handlers. The idea is taken from <span class="monospaced">lib-noir</span> but with slighty distinct approach.
</p>
</li>
</ul></div>
<div class="sect3">
<h4 id="_generic_authorization">4.4.1. Generic authorization</h4>
<div class="paragraph"><p>This authorization system encapsulates your hadlers/controllers in one try/catch block
catching only notauthorized exceptions. So spliting unauthorized request handling code from
your handlers/controllers in a separate function. Moreover, permits fast return when
not authorized request is detected.</p></div>
<div class="paragraph"><p>Like authentication system, authorization is also implemented using protocols. Taking advantage of
it, all builtin authentication backends implements authorization protocol.</p></div>
<div class="paragraph"><p>Some authentication backends requires specific behavior on authorization layer (like http-basic
that should return <span class="monospaced">WWW-Authenticate</span> header when request is unauthorized) and by default, all
builtin backends implements specific bahavior.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">You can overwrite the default handler, passing your own exception handler function as
<span class="monospaced">:unauthorized-handler</span> keyword parameter to backend constructor.</td>
</tr></table>
</div>
<div class="listingblock">
<div class="title">Example of how overwrite default behavior for unauthorized requests.</div>
<div class="content"><div class="highlight"><pre><span class="p">(</span><span class="kd">ns </span><span class="nv">myns.somensfile</span>
  <span class="p">(</span><span class="ss">:require</span> <span class="p">[</span><span class="nv">clojure.java.io</span> <span class="ss">:as</span> <span class="nv">io</span><span class="p">]</span>
            <span class="p">[</span><span class="nv">ring.util.response</span> <span class="ss">:refer</span> <span class="p">[</span><span class="nv">response</span> <span class="nv">redirect</span><span class="p">]]</span>
            <span class="p">[</span><span class="nv">buddy.auth</span> <span class="ss">:refer</span> <span class="p">[</span><span class="nv">authenticated?</span> <span class="nv">throw-notauthorized</span><span class="p">]]</span>
            <span class="p">[</span><span class="nv">buddy.auth.backends.httpbasic</span> <span class="ss">:refer</span> <span class="p">[</span><span class="nv">http-basic-backend</span><span class="p">]]</span>
            <span class="p">[</span><span class="nv">buddy.auth.middleware</span> <span class="ss">:refer</span> <span class="p">[</span><span class="nv">wrap-authentication</span> <span class="nv">wrap-authorization</span><span class="p">]]))</span>

<span class="c1">;; This function always receives a request and exception metadata.</span>

<span class="p">(</span><span class="kd">defn </span><span class="nv">my-unauthorized-handler</span>
  <span class="p">[</span><span class="nv">request</span> <span class="nv">metadata</span><span class="p">]</span>
  <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nf">authenticated?</span> <span class="nv">request</span><span class="p">)</span>
    <span class="p">(</span><span class="nf">response</span> <span class="p">(</span><span class="nf">io/resource</span> <span class="s">&quot;error.html&quot;</span><span class="p">))</span>
    <span class="p">(</span><span class="nf">redirect</span> <span class="s">&quot;/login&quot;</span><span class="p">)))</span>

<span class="p">(</span><span class="kd">defn </span><span class="nv">handler</span>
  <span class="p">[</span><span class="nv">request</span><span class="p">]</span>
  <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nf">authenticated?</span><span class="p">)</span>
    <span class="p">(</span><span class="nf">response</span> <span class="s">&quot;Hello World&quot;</span><span class="p">)</span>
    <span class="p">(</span><span class="nf">throw-notauthorized</span><span class="p">)))</span>

<span class="p">(</span><span class="kd">defn </span><span class="nv">-main</span>
  <span class="p">[</span><span class="o">&amp;</span> <span class="nv">args</span><span class="p">]</span>
  <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">backend</span> <span class="p">(</span><span class="nf">http-basic-backend</span> <span class="ss">:realm</span> <span class="s">&quot;Api&quot;</span>
                                    <span class="ss">:authfn</span> <span class="p">(</span><span class="k">fn </span><span class="p">[</span><span class="nv">_</span> <span class="nv">_</span><span class="p">]</span> <span class="ss">:foo-user</span><span class="p">)</span>
                                    <span class="ss">:unauthorized-handler</span> <span class="nv">my-unauthorized-handler</span><span class="p">)</span>
        <span class="nv">handler</span> <span class="p">(</span><span class="nb">-&gt; </span><span class="nv">handler</span>
                    <span class="p">(</span><span class="nf">wrap-authentication</span> <span class="nv">backend</span><span class="p">)</span>
                    <span class="p">(</span><span class="nf">wrap-authorization</span> <span class="nv">backend</span><span class="p">))]</span>
    <span class="p">(</span><span class="nf">jetty/run-jetty</span> <span class="nv">handler</span> <span class="p">{</span><span class="ss">:port</span> <span class="mi">9090</span><span class="p">})))</span>
</pre></div></div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">for you want know how it really works, see <a href="#how-it-works">How it works</a> section.</td>
</tr></table>
</div>
</div>
<div class="sect3">
<h4 id="_access_rules_system">4.4.2. Access Rules System</h4>
<div class="sect4">
<h5 id="_introduction_2">Introduction</h5>
<div class="paragraph"><p>Access rules is an other part of authorization system, and it consists on seting a list
of rules for a one or set uri&#8217;s using regular expressions. One rule consists in one regular
expression with associated handler (function) with authorization logic.</p></div>
<div class="paragraph"><p>Example:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="p">{</span><span class="ss">:pattern</span> <span class="o">#</span><span class="s">&quot;^/admin/.*&quot;</span>
 <span class="ss">:handler</span> <span class="nv">admin-access</span><span class="p">}</span>
</pre></div></div></div>
<div class="paragraph"><p>Having the <span class="monospaced">admin-access</span> function like this:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="p">(</span><span class="k">def </span><span class="nv">users</span> <span class="p">{</span><span class="ss">:niwibe</span> <span class="p">{</span><span class="ss">:roles</span> <span class="o">#</span><span class="p">{</span><span class="ss">:admin</span><span class="p">}}</span>
            <span class="ss">:pepe</span> <span class="p">{</span><span class="ss">:roles</span> <span class="o">#</span><span class="p">{</span><span class="ss">:user</span><span class="p">}}})</span>

<span class="p">(</span><span class="kd">defn </span><span class="nv">admin-access</span>
  <span class="p">[</span><span class="nv">request</span><span class="p">]</span>
  <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nb">identity </span><span class="p">(</span><span class="ss">:identity</span><span class="p">)]</span>
    <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nb">nil? </span><span class="nv">identity</span><span class="p">)</span> <span class="nv">false</span>
      <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">roles</span> <span class="p">(</span><span class="nb">-&gt; identity </span><span class="nv">users</span> <span class="ss">:roles</span><span class="p">)]</span>
        <span class="p">(</span><span class="nb">boolean </span><span class="p">(</span><span class="nf">roles</span> <span class="ss">:admin</span><span class="p">))))))</span>
</pre></div></div></div>
<div class="paragraph"><p>The handler function should receive a request and return: true, false or throw unauthorized
exception. Throwing unauthorized exception is a fast return method and no other handler
is excetured before it.</p></div>
<div class="paragraph"><p>In previous example we have seen a simple handler associated with one regular expression, but
<em>buddy</em> access rules system allows combine more handlers using logical <span class="monospaced">:and</span> &amp; <span class="monospaced">:or</span> combinators
with nesting support.</p></div>
<div class="paragraph"><p>Imagine the scenario when you want allow access to a set of urls to operators or administrators:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="p">{</span><span class="ss">:pattern</span> <span class="o">#</span><span class="s">&quot;^/admin/.*&quot;</span>
 <span class="ss">:handler</span> <span class="p">{</span><span class="ss">:or</span> <span class="p">[</span><span class="nv">admin-access</span> <span class="nv">operator-access</span><span class="p">]}}</span>
</pre></div></div></div>
<div class="paragraph"><p>Or, allow only when a user has both roles, operator and administrator:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="p">{</span><span class="ss">:pattern</span> <span class="o">#</span><span class="s">&quot;^/admin/.*&quot;</span>
 <span class="ss">:handler</span> <span class="p">{</span><span class="ss">:and</span> <span class="p">[</span><span class="nv">admin-access</span> <span class="nv">operator-access</span><span class="p">]}}</span>
</pre></div></div></div>
<div class="paragraph"><p>Even more, you want allow readwrite access to administrators and operators, and
readonly access to any authenticated user:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="p">{</span><span class="ss">:pattern</span> <span class="o">#</span><span class="s">&quot;^/admin/.*&quot;</span>
 <span class="ss">:handler</span> <span class="p">{</span><span class="ss">:or</span> <span class="p">[</span><span class="nv">admin-access</span> <span class="nv">operator-access</span>
               <span class="p">{</span><span class="ss">:and</span> <span class="p">[</span><span class="nv">safemethod-access</span> <span class="nv">authenticated-access</span><span class="p">]}]}}</span>
</pre></div></div></div>
</div>
<div class="sect4">
<h5 id="_how_to_use_it">How to use it?</h5>
<div class="paragraph"><p>Access rules system is still flexible for adapt it for a lot of case uses is very
simple.</p></div>
<div class="paragraph"><p>The simplest way to use access rules, is using <span class="monospaced">wrap-access-rules</span> middleware
passing to it a ordered vector of rules. Important: rules are evaluated in order,
therefore, put less restrictive regular expression on the end.</p></div>
<div class="listingblock">
<div class="title"><em>myapp.clj</em></div>
<div class="content"><div class="highlight"><pre><span class="p">(</span><span class="kd">ns </span><span class="nv">myapp</span>
  <span class="p">(</span><span class="ss">:require</span> <span class="p">[</span><span class="nv">myapp.routes</span> <span class="ss">:refer</span> <span class="p">[</span><span class="nv">app</span><span class="p">]]</span>
            <span class="p">[</span><span class="nv">myapp.permissions</span> <span class="ss">:refer</span> <span class="p">[</span><span class="nv">admin-access</span> <span class="nv">operator-access</span>
                                       <span class="nv">any-access</span> <span class="nv">authenticated-access</span><span class="p">]]</span>
            <span class="p">[</span><span class="nv">buddy.auth.middleware</span> <span class="ss">:refer</span> <span class="p">[</span><span class="nv">wrap-access-rules</span><span class="p">]]))</span>

<span class="p">(</span><span class="k">def </span><span class="nv">rules</span> <span class="p">[{</span><span class="ss">:pattern</span> <span class="o">#</span><span class="s">&quot;^/admin/.*&quot;</span>
             <span class="ss">:handler</span> <span class="p">{</span><span class="ss">:or</span> <span class="p">[</span><span class="nv">admin-access</span> <span class="nv">operator-access</span><span class="p">]}}</span>
            <span class="p">{</span><span class="ss">:pattern</span> <span class="o">#</span><span class="s">&quot;^/login$&quot;</span>
             <span class="ss">:handler</span> <span class="nv">any-access</span><span class="p">}</span>
            <span class="p">{</span><span class="ss">:pattern</span> <span class="o">#</span><span class="s">&quot;^/.*&quot;</span>
             <span class="ss">:handler</span> <span class="nv">authenticated-access</span><span class="p">}])</span>

<span class="c1">;; Function that used for handle unauthorized requests</span>
<span class="p">(</span><span class="kd">defn </span><span class="nv">reject-handler</span>
  <span class="p">[</span><span class="nv">request</span><span class="p">]</span>
  <span class="p">{</span><span class="ss">:status</span> <span class="mi">403</span>
   <span class="ss">:headers</span> <span class="p">{}</span>
   <span class="ss">:body</span> <span class="s">&quot;Not authorized&quot;</span><span class="p">})</span>

<span class="p">(</span><span class="kd">defn </span><span class="nv">-main</span>
  <span class="p">[</span><span class="o">&amp;</span> <span class="nv">args</span><span class="p">]</span>
  <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">handler</span> <span class="p">(</span><span class="nf">wrap-access-rules</span> <span class="nv">app</span> <span class="nv">rules</span> <span class="p">{</span><span class="ss">:reject-handler</span> <span class="nv">reject-handler</span><span class="p">}))]</span>
    <span class="p">(</span><span class="nf">jetty/run-jetty</span> <span class="nv">handler</span> <span class="p">{</span><span class="ss">:port</span> <span class="mi">9090</span><span class="p">}))</span>
</pre></div></div></div>
<div class="paragraph"><p>If no reject handler is specified, unauthorized exception is raised. These exception
can be captured by generic authorization middleware.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">The current request uri not match any regular expresion, the default policy enter in
action. The default policy in <em>buddy</em> is <span class="monospaced">:allow</span> but you can change it to <span class="monospaced">:reject</span>
using keyword <span class="monospaced">:policy</span> on wrap-access-rules middleware.</td>
</tr></table>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_advanced_usage">5. Advanced Usage</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="how-it-works">5.1. How It Works</h3>
<div class="paragraph"><p>Each backend implements two protocols: <span class="monospaced">IAuthentication</span> and <span class="monospaced">IAuthorization</span>.</p></div>
<div class="paragraph"><p><strong>IAuthentication</strong> provides two functions: <span class="monospaced">parse</span> and <span class="monospaced">authenticate</span> and is automaticaly
handled with <span class="monospaced">wrap-authentication</span> ring middleware. This is a example flow of http basic
backend:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
Received request, is passed to <span class="monospaced">parse</span> function. This function, extracts <span class="monospaced">Authorization</span>
   header, decode a base64 encoded string and return clojure map with <span class="monospaced">:username</span> and <span class="monospaced">:password</span>
   keys. If parse error is ocurred, it returns nil.
</p>
</li>
<li>
<p>
If previous step parses token successfully, <span class="monospaced">authenticate</span> function is called with current
   request and parsed data from previous step. <span class="monospaced">authenticate</span> can delegate authentication
   to user defined function passed as <span class="monospaced">:authfn</span> parameter to backend constructor.
   <span class="monospaced">authenticate</span> should return a request with <span class="monospaced">:identity</span> key assigned to nil or any other
   value. All requests with <span class="monospaced">:identity</span> key with nil value are considered not authenticated.
</p>
</li>
<li>
<p>
User handler is called.
</p>
</li>
</ol></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="ulist"><ul>
<li>
<p>
<span class="monospaced">parse</span> function can return valid response, in that case response is returned inmediatel
  ignoring user handler.
</p>
</li>
<li>
<p>
if <span class="monospaced">parse</span> function returns nil, <span class="monospaced">authenticate</span> function is ignored and user handler is
  called directly.
</p>
</li>
<li>
<p>
<span class="monospaced">authenticate</span> also can return a valid response, in these case it has same behavior that
  with <span class="monospaced">parse</span> function.
</p>
</li>
</ul></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p><strong>IAuthorization</strong> provides <span class="monospaced">handle-unauthorized</span> function. Each backend implements it default
behavior but it can be overwritted with user defined function, passed on <span class="monospaced">:handle-unauthorized</span>
keyword parameter to backend constructor. It always should return a valid response.</p></div>
<div class="paragraph"><p>Authorization is handled automatically with <span class="monospaced">wrap-authorization</span> ring middleware. It wraps
all request in try/catch block for intercept only authorization exception.</p></div>
<div class="paragraph"><p>This is a flow that follows authorization middleware:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
User handler is wrapped in try/catch block and executed.
</p>
</li>
<li>
<p>
Not authorized exception is raised with <span class="monospaced">buddy.auth/throw-notauthorized</span> function from
   any part of your handler.
</p>
</li>
<li>
<p>
handle-unauthorized is executed of your backend, if user has specified it own function,
   the user defined function is executed else, default behavior is executed.
</p>
</li>
</ol></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_examples">6. Examples</h2>
<div class="sectionbody">
<div class="paragraph"><p><em>buddy</em> comes with some examples for facilitate a new user understand how it works. All
examples are available on <span class="monospaced">examples/</span> directory on root project.</p></div>
<div class="paragraph"><p>At this momment one example is available:</p></div>
<div class="ulist"><ul>
<li>
<p>
<a href="https://github.com/niwibe/buddy/tree/master/examples/sessionexample">Use session backend as authentication and authorization.</a>
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect1">
<h2 id="_how_to_contribute">7. How to contribute</h2>
<div class="sectionbody">
<div class="paragraph"><p><em>buddy</em> unlike clojure and other clojure contrib libs, does not have much restrictions for contribute. Just
follow the following steps depending on the situation:</p></div>
<div class="paragraph"><p><strong>Bugfix</strong>:</p></div>
<div class="ulist"><ul>
<li>
<p>
Fork github repo.
</p>
</li>
<li>
<p>
Fix a bug/typo on new branch.
</p>
</li>
<li>
<p>
Make a pull-request to master.
</p>
</li>
</ul></div>
<div class="paragraph"><p><strong>New feature</strong>:</p></div>
<div class="ulist"><ul>
<li>
<p>
Open new issue with new feature purpose.
</p>
</li>
<li>
<p>
If it is accepted, follow same steps as "bugfix".
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect1">
<h2 id="_faq">8. FAQ</h2>
<div class="sectionbody">
<div class="paragraph"><p><strong>How can use <em>buddy</em> with <a href="http://clojure-liberator.github.io/liberator/">liberator</a>?</strong></p></div>
<div class="paragraph"><p><em>buddy</em> by design, has authorization and authentication concepts well separated. This
helps a lot if you want use some one part of it (ex: authentencation only) without including
other parts.</p></div>
<div class="paragraph"><p>This makes, integration with liberator very simple, because liberator comes with good
decision handlers for authorization and by normally usage, you should use it instead
of integrate other third party authorization system to liberator.</p></div>
<div class="paragraph"><p>The best combination is use <em>buddy</em> authentication middleware with liberator (using it
authorization system).</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_license">9. License</h2>
<div class="sectionbody">
<div class="listingblock">
<div class="content"><div class="highlight"><pre>Copyright 2013 Andrey Antukh &lt;niwi@niwi.be&gt;

Licensed under the Apache License, Version 2.0 (the &quot;License&quot;)
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
</pre></div></div></div>
</div>
</div>
</div>
<div id="footnotes"><hr></div>
<div id="footer">
<div id="footer-text">
Version 0.1.0<br>
Last updated 2014-02-09 12:00:28 CET
</div>
</div>
</body>
</html>
